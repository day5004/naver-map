<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naver Map</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=0lep6flysx"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .control-btn {
            display: block;
            width: 120px;
            padding: 8px;
            margin: 5px 0;
            background: #03CF5D;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .control-btn:hover {
            background: #00b350;
        }
        
        .control-btn.active {
            background: #FF3E3E;
        }
        
        .control-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .info-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 12px;
        }
        
        .info-row {
            margin: 3px 0;
        }
        
        .info-row span {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <button id="myLocationBtn" class="control-btn">내 위치</button>
        <button id="startTrackingBtn" class="control-btn">추적 시작</button>
        <button id="stopTrackingBtn" class="control-btn active" style="display:none;">추적 중지</button>
        <button id="clearRouteBtn" class="control-btn">경로 초기화</button>
        <button id="saveMapBtn" class="control-btn">지도 저장</button>
    </div>
    
    <div class="info-panel">
        <div class="info-row">위도: <span id="lat">0.000000</span></div>
        <div class="info-row">경도: <span id="lng">0.000000</span></div>
        <div class="info-row">정확도: <span id="accuracy">N/A</span></div>
        <div class="info-row">상태: <span id="status">대기중</span></div>
        <div class="info-row">포인트: <span id="pointCount">0</span>개</div>
        <div class="info-row">거리: <span id="distance">0</span>m</div>
    </div>

    <script>
        // 전역 변수
        let map;
        let userMarker = null;
        let routePath = null;
        let routeCoordinates = [];
        let isTracking = false;
        let startMarker = null;
        let endMarker = null;
        let totalDistance = 0;

        // Unity와 통신하는 브릿지 객체
        window.NaverMapBridge = {
            userLocation: null,
            isTrackingFromUnity: false,
            
            // Unity에서 추적 상태 설정
            setTrackingState: function(state) {
                console.log('Unity tracking state:', state);
                this.isTrackingFromUnity = state;
                if (state && !isTracking) {
                    startTracking();
                } else if (!state && isTracking) {
                    stopTracking();
                }
            },
            
            // Unity에서 위치 업데이트 받기 (플러그인 GPS 데이터)
            updateLocation: function(lat, lng, accuracy) {
                console.log('GPS from Plugin:', lat, lng, accuracy);
                
                this.userLocation = new naver.maps.LatLng(lat, lng);
                
                // 사용자 마커 업데이트
                if (userMarker) {
                    userMarker.setPosition(this.userLocation);
                } else if (map) {
                    userMarker = new naver.maps.Marker({
                        position: this.userLocation,
                        map: map,
                        icon: {
                            content: '<div style="width:20px;height:20px;background:#4285F4;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                            anchor: new naver.maps.Point(13, 13)
                        },
                        zIndex: 100
                    });
                }
                
                // Unity 추적 상태와 동기화
                if (this.isTrackingFromUnity && !isTracking) {
                    startTracking();
                }
                
                // 경로 추적 중이면 경로에 추가
                if (isTracking) {
                    if (routeCoordinates.length === 0) {
                        // 첫 포인트는 바로 추가
                        addRoutePoint(lat, lng);
                    } else {
                        // 마지막 포인트와의 거리 체크
                        const lastPoint = routeCoordinates[routeCoordinates.length - 1];
                        const distance = calculateDistance(
                            lastPoint.lat(), lastPoint.lng(),
                            lat, lng
                        );
                        
                        // 3미터 이상 이동시 경로 추가
                        if (distance > 3) {
                            addRoutePoint(lat, lng);
                            totalDistance += distance;
                            document.getElementById('distance').textContent = Math.round(totalDistance);
                        }
                    }
                }
                
                // 정보 패널 업데이트
                updateInfoPanel(lat, lng, accuracy);
            },
            
            // 지도 이동
            moveToLocation: function(lat, lng) {
                if (map) {
                    map.setCenter(new naver.maps.LatLng(lat, lng));
                }
            },
            
            // 줌 설정
            setZoom: function(level) {
                if (map) {
                    map.setZoom(level);
                }
            },
            
            // 경로 추적 시작 (Unity에서 호출)
            startTracking: function() {
                if (!isTracking) {
                    startTracking();
                }
            },
            
            // 경로 추적 중지 (Unity에서 호출)
            stopTracking: function() {
                if (isTracking) {
                    stopTracking();
                }
            },
            
            // 경로에 점 추가 (Unity에서 호출)
            addRoutePoint: function(lat, lng) {
                addRoutePoint(lat, lng);
            }
        };

        // 지도 초기화
        function initMap() {
            const mapOptions = {
                center: new naver.maps.LatLng(37.5665, 126.9780),
                zoom: 16,
                mapTypeControl: false,
                scaleControl: false,
                logoControl: false,
                mapDataControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: naver.maps.Position.TOP_RIGHT
                }
            };

            map = new naver.maps.Map('map', mapOptions);
            
            // 지도 준비 완료 알림
            document.getElementById('status').textContent = 'GPS 대기중';
        }

        // 경로 추적 시작
        function startTracking() {
            if (!isTracking) {
                isTracking = true;
                
                // 이전 경로가 없으면 새로 시작
                if (routeCoordinates.length === 0) {
                    totalDistance = 0;
                    
                    // 현재 위치를 시작점으로
                    if (window.NaverMapBridge.userLocation) {
                        routeCoordinates.push(window.NaverMapBridge.userLocation);
                        
                        // 시작 마커 생성
                        if (startMarker) {
                            startMarker.setMap(null);
                        }
                        startMarker = new naver.maps.Marker({
                            position: window.NaverMapBridge.userLocation,
                            map: map,
                            icon: {
                                content: '<div style="width:15px;height:15px;background:#00C73C;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                                anchor: new naver.maps.Point(9, 9)
                            },
                            zIndex: 90
                        });
                    }
                }
                
                // UI 업데이트
                document.getElementById('startTrackingBtn').style.display = 'none';
                document.getElementById('stopTrackingBtn').style.display = 'block';
                document.getElementById('status').textContent = '추적 중';
                
                console.log('Route tracking started');
            }
        }

        // 경로 추적 중지
        function stopTracking() {
            if (isTracking) {
                isTracking = false;
                
                // 종료 마커 생성
                if (routeCoordinates.length > 0) {
                    if (endMarker) {
                        endMarker.setMap(null);
                    }
                    const lastPoint = routeCoordinates[routeCoordinates.length - 1];
                    endMarker = new naver.maps.Marker({
                        position: lastPoint,
                        map: map,
                        icon: {
                            content: '<div style="width:15px;height:15px;background:#FF3E3E;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                            anchor: new naver.maps.Point(9, 9)
                        },
                        zIndex: 90
                    });
                }
                
                // UI 업데이트
                document.getElementById('startTrackingBtn').style.display = 'block';
                document.getElementById('stopTrackingBtn').style.display = 'none';
                document.getElementById('status').textContent = '추적 중지';
                
                console.log('Route tracking stopped');
            }
        }

        // 경로에 포인트 추가
        function addRoutePoint(lat, lng) {
            const point = new naver.maps.LatLng(lat, lng);
            routeCoordinates.push(point);
            
            // 경로 업데이트
            updateRoute();
            
            // 포인트 수 업데이트
            document.getElementById('pointCount').textContent = routeCoordinates.length;
            
            console.log('Point added:', lat, lng, 'Total:', routeCoordinates.length);
        }

        // 경로 그리기 업데이트
        function updateRoute() {
            if (routePath) {
                routePath.setMap(null);
            }
            
            if (routeCoordinates.length > 1) {
                routePath = new naver.maps.Polyline({
                    map: map,
                    path: routeCoordinates,
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.8,
                    strokeWeight: 4,
                    strokeLineCap: 'round',
                    strokeLineJoin: 'round'
                });
            }
        }

        // 경로 초기화
        function clearRoute() {
            routeCoordinates = [];
            isTracking = false;
            totalDistance = 0;
            
            if (routePath) {
                routePath.setMap(null);
                routePath = null;
            }
            
            if (startMarker) {
                startMarker.setMap(null);
                startMarker = null;
            }
            
            if (endMarker) {
                endMarker.setMap(null);
                endMarker = null;
            }
            
            // UI 업데이트
            document.getElementById('status').textContent = '경로 초기화됨';
            document.getElementById('pointCount').textContent = '0';
            document.getElementById('distance').textContent = '0';
            document.getElementById('startTrackingBtn').style.display = 'block';
            document.getElementById('stopTrackingBtn').style.display = 'none';
            
            console.log('Route cleared');
        }

        // 저장된 경로 복원 (Unity에서 호출)
        window.restoreRoute = function(pointsJson) {
            try {
                const points = JSON.parse(pointsJson);
                routeCoordinates = [];
                totalDistance = 0;
                
                points.forEach((p, index) => {
                    const point = new naver.maps.LatLng(p.lat, p.lng);
                    routeCoordinates.push(point);
                    
                    // 거리 계산
                    if (index > 0) {
                        const prevPoint = routeCoordinates[index - 1];
                        totalDistance += calculateDistance(
                            prevPoint.lat(), prevPoint.lng(),
                            point.lat(), point.lng()
                        );
                    }
                });
                
                // 경로 그리기
                updateRoute();
                
                // 시작/끝 마커 생성
                if (routeCoordinates.length > 0) {
                    // 시작 마커
                    if (startMarker) startMarker.setMap(null);
                    startMarker = new naver.maps.Marker({
                        position: routeCoordinates[0],
                        map: map,
                        icon: {
                            content: '<div style="width:15px;height:15px;background:#00C73C;border-radius:50%;border:2px solid white;"></div>',
                            anchor: new naver.maps.Point(9, 9)
                        }
                    });
                    
                    // 끝 마커 (추적 중지 상태일 때만)
                    if (!isTracking && routeCoordinates.length > 1) {
                        if (endMarker) endMarker.setMap(null);
                        endMarker = new naver.maps.Marker({
                            position: routeCoordinates[routeCoordinates.length - 1],
                            map: map,
                            icon: {
                                content: '<div style="width:15px;height:15px;background:#FF3E3E;border-radius:50%;border:2px solid white;"></div>',
                                anchor: new naver.maps.Point(9, 9)
                            }
                        });
                    }
                }
                
                // UI 업데이트
                document.getElementById('pointCount').textContent = routeCoordinates.length;
                document.getElementById('distance').textContent = Math.round(totalDistance);
                
                console.log('Restored', routeCoordinates.length, 'points');
            } catch (e) {
                console.error('Failed to restore route:', e);
            }
        };

        // 거리 계산 (미터)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // 지구 반지름 (미터)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // 정보 패널 업데이트
        function updateInfoPanel(lat, lng, accuracy) {
            document.getElementById('lat').textContent = lat.toFixed(6);
            document.getElementById('lng').textContent = lng.toFixed(6);
            document.getElementById('accuracy').textContent = accuracy ? accuracy.toFixed(1) + 'm' : 'N/A';
        }

        // 버튼 이벤트 리스너
        document.getElementById('myLocationBtn').addEventListener('click', function() {
            if (window.NaverMapBridge.userLocation) {
                map.setCenter(window.NaverMapBridge.userLocation);
                map.setZoom(17);
            } else {
                alert('GPS 위치를 받아오는 중입니다...');
            }
        });

        document.getElementById('startTrackingBtn').addEventListener('click', function() {
            startTracking();
            // Unity에 알림
            window.location.href = 'unity://start_tracking';
        });

        document.getElementById('stopTrackingBtn').addEventListener('click', function() {
            stopTracking();
            // Unity에 알림
            window.location.href = 'unity://stop_tracking';
        });

        document.getElementById('clearRouteBtn').addEventListener('click', function() {
            if (routeCoordinates.length > 0) {
                if (confirm('경로를 초기화하시겠습니까?\n저장된 모든 경로가 삭제됩니다.')) {
                    clearRoute();
                    // Unity에 알림
                    window.location.href = 'unity://clear_route';
                }
            } else {
                alert('초기화할 경로가 없습니다.');
            }
        });

        document.getElementById('saveMapBtn').addEventListener('click', function() {
            if (routeCoordinates.length > 0) {
                // Unity에 알림
                window.location.href = 'unity://save_static_map';
            } else {
                alert('저장할 경로가 없습니다.');
            }
        });

        // 전역 함수로 등록 (Unity에서 호출용)
        window.startRoute = startTracking;
        window.stopRoute = stopTracking;
        window.clearRoute = clearRoute;
        window.addRoutePoint = addRoutePoint;

        // 지도 초기화 실행
        window.onload = function() {
            initMap();
            console.log('Map initialized');
        };
    </script>
</body>
</html>
