<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Naver Map GPS Tracker</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=4h5ui0cr6w"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* GPS 정보 패널 */
        .info-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .info-panel .row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        .info-panel .label {
            color: #666;
            margin-right: 10px;
        }
        .info-panel .value {
            font-weight: bold;
            color: #333;
        }
        .info-panel .status {
            color: #4CAF50;
            font-weight: bold;
        }
        .info-panel .status.stopped {
            color: #f44336;
        }
        
        /* 컨트롤 버튼 */
        .control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        .control-btn {
            display: block;
            width: 100px;
            padding: 10px;
            margin-bottom: 5px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        .btn-warning {
            background: #FF9800;
            color: white;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- 컨트롤 패널 -->
    <div class="control-panel">
        <button class="control-btn btn-primary" onclick="NaverMapBridge.moveToMyLocation()">내 위치</button>
        <button class="control-btn btn-danger" id="trackingBtn" onclick="NaverMapBridge.toggleTracking()">추적 중지</button>
        <button class="control-btn btn-secondary" onclick="NaverMapBridge.clearRoute()">경로 초기화</button>
        <button class="control-btn btn-warning" onclick="NaverMapBridge.saveMap()">지도 저장</button>
    </div>
    
    <!-- 정보 패널 -->
    <div class="info-panel">
        <div class="row">
            <span class="label">위도:</span>
            <span class="value" id="lat">0.000000</span>
        </div>
        <div class="row">
            <span class="label">경도:</span>
            <span class="value" id="lng">0.000000</span>
        </div>
        <div class="row">
            <span class="label">정확도:</span>
            <span class="value" id="accuracy">0.0m</span>
        </div>
        <div class="row">
            <span class="label">상태:</span>
            <span class="status" id="status">준비완료</span>
        </div>
        <div class="row">
            <span class="label">포인트:</span>
            <span class="value"><span id="points">0</span> 개</span>
        </div>
        <div class="row">
            <span class="label">거리:</span>
            <span class="value"><span id="distance">0</span> m</span>
        </div>
    </div>

    <script>
        // ⭐ 전역 변수
        var map;
        var currentMarker;
        var routeLine;
        var startMarker;
        var endMarker;
        var collectedPoints = [];
        var isTracking = true;
        var totalDistance = 0;

        // ⭐ 지도 초기화
        function initMap() {
            var mapOptions = {
                center: new naver.maps.LatLng(37.5665, 126.9780), // 서울 시청
                zoom: 17,
                mapTypeControl: false,
                scaleControl: true,
                logoControl: false,
                mapDataControl: false
            };

            map = new naver.maps.Map('map', mapOptions);
            console.log('Map initialized');
        }

        // ⭐⭐⭐ NaverMapBridge - Unity와 통신하는 메인 객체 ⭐⭐⭐
        window.NaverMapBridge = {
            
            // 위치 업데이트 (Unity에서 호출)
            updateLocation: function(lat, lng, accuracy) {
                console.log('updateLocation called:', lat, lng, accuracy);
                
                var position = new naver.maps.LatLng(lat, lng);
                
                // 현재 위치 마커 업데이트
                if (currentMarker) {
                    currentMarker.setPosition(position);
                } else {
                    currentMarker = new naver.maps.Marker({
                        position: position,
                        map: map,
                        icon: {
                            content: '<div style="width:20px;height:20px;background:#4285F4;border:3px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                            anchor: new naver.maps.Point(10, 10)
                        }
                    });
                }
                
                // 지도 중심 이동
                map.setCenter(position);
                
                // 정보 패널 업데이트
                document.getElementById('lat').textContent = lat.toFixed(6);
                document.getElementById('lng').textContent = lng.toFixed(6);
                document.getElementById('accuracy').textContent = (accuracy || 10).toFixed(1) + 'm';
                
                // 추적 중이면 포인트 수집
                if (isTracking) {
                    this.addRoutePoint(lat, lng);
                }
            },
            
            // 경로 포인트 추가
            addRoutePoint: function(lat, lng) {
                var newPoint = {lat: lat, lng: lng};
                
                // 첫 포인트가 아니면 거리 계산
                if (collectedPoints.length > 0) {
                    var lastPoint = collectedPoints[collectedPoints.length - 1];
                    var dist = this.calculateDistance(lastPoint.lat, lastPoint.lng, lat, lng);
                    
                    // 3m 미만이면 무시
                    if (dist < 3) {
                        return;
                    }
                    
                    // 100m 이상 점프면 무시
                    if (dist > 100) {
                        console.log('Jump detected, ignoring point');
                        return;
                    }
                    
                    totalDistance += dist;
                }
                
                collectedPoints.push(newPoint);
                
                // UI 업데이트
                document.getElementById('points').textContent = collectedPoints.length;
                document.getElementById('distance').textContent = Math.round(totalDistance);
                document.getElementById('status').textContent = '추적 중';
                document.getElementById('status').className = 'status';
                
                // 경로 다시 그리기
                this.drawSmoothRoute();
                
                // 시작/끝 마커 업데이트
                this.updateMarkers();
            },
            
            // ⭐⭐⭐ 부드러운 경로 그리기 (핵심!) ⭐⭐⭐
            drawSmoothRoute: function() {
                if (collectedPoints.length < 2) return;
                
                // 포인트 스무딩 적용
                var smoothedPoints = this.smoothPoints(collectedPoints);
                
                // LatLng 배열로 변환
                var path = smoothedPoints.map(function(p) {
                    return new naver.maps.LatLng(p.lat, p.lng);
                });
                
                if (routeLine) {
                    routeLine.setPath(path);
                } else {
                    routeLine = new naver.maps.Polyline({
                        map: map,
                        path: path,
                        strokeColor: '#0080FF',      // 파란색
                        strokeWeight: 6,              // 두께
                        strokeOpacity: 0.8,           // 투명도
                        strokeLineCap: 'round',       // ⭐ 끝을 둥글게
                        strokeLineJoin: 'round'       // ⭐ 연결 부분 둥글게
                    });
                }
            },
            
            // ⭐⭐⭐ 포인트 스무딩 (3점 이동 평균 + 베지어 보간) ⭐⭐⭐
            smoothPoints: function(points) {
                if (points.length < 3) return points;
                
                var smoothed = [];
                
                // 첫 포인트
                smoothed.push(points[0]);
                
                for (var i = 1; i < points.length - 1; i++) {
                    var prev = points[i - 1];
                    var curr = points[i];
                    var next = points[i + 1];
                    
                    // 3점 이동 평균
                    var avgLat = (prev.lat + curr.lat + next.lat) / 3;
                    var avgLng = (prev.lng + curr.lng + next.lng) / 3;
                    
                    // 이전 점과 평균점 사이에 중간점 추가 (더 부드럽게)
                    var midLat1 = (smoothed[smoothed.length - 1].lat + avgLat) / 2;
                    var midLng1 = (smoothed[smoothed.length - 1].lng + avgLng) / 2;
                    
                    smoothed.push({lat: midLat1, lng: midLng1});
                    smoothed.push({lat: avgLat, lng: avgLng});
                }
                
                // 마지막 포인트
                smoothed.push(points[points.length - 1]);
                
                return smoothed;
            },
            
            // Unity에서 직접 경로 그리기 (호환성)
            drawRoute: function(points) {
                if (!points || points.length < 2) return;
                
                collectedPoints = points;
                totalDistance = 0;
                
                // 거리 재계산
                for (var i = 1; i < points.length; i++) {
                    totalDistance += this.calculateDistance(
                        points[i-1].lat, points[i-1].lng,
                        points[i].lat, points[i].lng
                    );
                }
                
                document.getElementById('points').textContent = points.length;
                document.getElementById('distance').textContent = Math.round(totalDistance);
                
                this.drawSmoothRoute();
                this.updateMarkers();
            },
            
            // 시작/끝 마커 업데이트
            updateMarkers: function() {
                if (collectedPoints.length === 0) return;
                
                // 시작 마커 (녹색)
                var startPos = new naver.maps.LatLng(collectedPoints[0].lat, collectedPoints[0].lng);
                if (startMarker) {
                    startMarker.setPosition(startPos);
                } else {
                    startMarker = new naver.maps.Marker({
                        position: startPos,
                        map: map,
                        icon: {
                            content: '<div style="width:14px;height:14px;background:#4CAF50;border:2px solid white;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                            anchor: new naver.maps.Point(7, 7)
                        }
                    });
                }
                
                // 끝 마커 (빨간색) - 포인트가 2개 이상일 때만
                if (collectedPoints.length > 1) {
                    var endPos = new naver.maps.LatLng(
                        collectedPoints[collectedPoints.length - 1].lat,
                        collectedPoints[collectedPoints.length - 1].lng
                    );
                    if (endMarker) {
                        endMarker.setPosition(endPos);
                    } else {
                        endMarker = new naver.maps.Marker({
                            position: endPos,
                            map: map,
                            icon: {
                                content: '<div style="width:14px;height:14px;background:#f44336;border:2px solid white;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                                anchor: new naver.maps.Point(7, 7)
                            }
                        });
                    }
                }
            },
            
            // 거리 계산 (Haversine 공식)
            calculateDistance: function(lat1, lng1, lat2, lng2) {
                var R = 6371000; // 지구 반지름 (미터)
                var dLat = (lat2 - lat1) * Math.PI / 180;
                var dLng = (lng2 - lng1) * Math.PI / 180;
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng / 2) * Math.sin(dLng / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            },
            
            // 내 위치로 이동
            moveToMyLocation: function() {
                if (currentMarker) {
                    map.setCenter(currentMarker.getPosition());
                    map.setZoom(17);
                }
            },
            
            // 특정 위치로 이동
            moveToLocation: function(lat, lng) {
                map.setCenter(new naver.maps.LatLng(lat, lng));
            },
            
            // 줌 설정
            setZoom: function(level) {
                map.setZoom(level);
            },
            
            // 추적 시작/중지 토글
            toggleTracking: function() {
                isTracking = !isTracking;
                var btn = document.getElementById('trackingBtn');
                var status = document.getElementById('status');
                
                if (isTracking) {
                    btn.textContent = '추적 중지';
                    btn.className = 'control-btn btn-danger';
                    status.textContent = '추적 중';
                    status.className = 'status';
                } else {
                    btn.textContent = '추적 시작';
                    btn.className = 'control-btn btn-primary';
                    status.textContent = '중지됨';
                    status.className = 'status stopped';
                }
                
                // Unity에 상태 전달
                if (window.Unity) {
                    window.Unity.call('unity://tracking_' + (isTracking ? 'start' : 'stop'));
                }
            },
            
            // 추적 시작 (Unity에서 호출)
            startTracking: function() {
                isTracking = true;
                var btn = document.getElementById('trackingBtn');
                var status = document.getElementById('status');
                btn.textContent = '추적 중지';
                btn.className = 'control-btn btn-danger';
                status.textContent = '추적 중';
                status.className = 'status';
            },
            
            // 추적 중지 (Unity에서 호출)
            stopTracking: function() {
                isTracking = false;
                var btn = document.getElementById('trackingBtn');
                var status = document.getElementById('status');
                btn.textContent = '추적 시작';
                btn.className = 'control-btn btn-primary';
                status.textContent = '중지됨';
                status.className = 'status stopped';
            },
            
            // 경로 초기화
            clearRoute: function() {
                collectedPoints = [];
                totalDistance = 0;
                
                if (routeLine) {
                    routeLine.setMap(null);
                    routeLine = null;
                }
                if (startMarker) {
                    startMarker.setMap(null);
                    startMarker = null;
                }
                if (endMarker) {
                    endMarker.setMap(null);
                    endMarker = null;
                }
                
                document.getElementById('points').textContent = '0';
                document.getElementById('distance').textContent = '0';
                
                console.log('Route cleared');
                
                // Unity에 알림
                if (window.Unity) {
                    window.Unity.call('unity://route_cleared');
                }
            },
            
            // 지도 저장 (Unity에 요청)
            saveMap: function() {
                if (window.Unity) {
                    window.Unity.call('unity://save_map');
                }
                alert('지도 저장을 요청했습니다.');
            },
            
            // 현재 포인트 가져오기
            getPoints: function() {
                return JSON.stringify(collectedPoints);
            },
            
            // 총 거리 가져오기
            getTotalDistance: function() {
                return totalDistance;
            }
        };

        // 기존 함수들 (하위 호환성)
        window.clearRoute = function() {
            NaverMapBridge.clearRoute();
        };
        
        window.startRoute = function() {
            NaverMapBridge.startTracking();
        };
        
        window.addRoutePoint = function(lat, lng) {
            NaverMapBridge.addRoutePoint(lat, lng);
        };

        // 페이지 로드 시 지도 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            console.log('Naver Map ready for Unity');
        });
    </script>
</body>
</html>
