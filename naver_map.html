<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Naver Map with Floating Support</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=0lep6flysx"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        html, body {
            overflow: hidden;
            touch-action: none;
            -webkit-overflow-scrolling: touch;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            touch-action: manipulation;
        }
        
        /* === ì •ë³´ íŒ¨ë„ (ìš°í•˜ë‹¨) === */
        .info-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 11px;
            min-width: 150px;
        }
        
        .info-row {
            margin: 2px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .info-row span {
            font-weight: bold;
            color: #333;
        }
        
        .status-tracking {
            color: #03CF5D !important;
        }
        
        .status-stopped {
            color: #FF3E3E !important;
        }
        
        /* === í”Œë¡œíŒ… ëª¨ë“œ ì „ìš© ìŠ¤íƒ€ì¼ === */
        .floating-mode .info-panel {
            position: fixed;
            top: 5px;
            right: 5px;
            bottom: auto;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 9px !important;
            padding: 4px 6px;
            min-width: 80px;
            border-radius: 4px;
        }
        
        .floating-mode .info-row {
            margin: 1px 0;
        }
        
        .floating-mode .info-row label {
            color: #aaa;
            font-size: 8px;
            margin-right: 3px;
        }
        
        .floating-mode .info-row span {
            color: #fff;
            font-size: 9px;
        }
        
        /* í”Œë¡œíŒ… ëª¨ë“œì—ì„œ ì¼ë¶€ ì •ë³´ ìˆ¨ê¹€ */
        .floating-mode .info-row.accuracy,
        .floating-mode .info-row.distance {
            display: none;
        }
        
        /* ì§€ë„ ì»¨íŠ¸ë¡¤ ìˆ¨ê¸°ê¸° */
        .floating-mode .naver-map-control {
            display: none !important;
        }
        
        @media (max-width: 600px) {
            .info-panel {
                bottom: 5px;
                right: 5px;
                font-size: 10px;
                padding: 6px 10px;
                min-width: 130px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- ì •ë³´ íŒ¨ë„ë§Œ í‘œì‹œ (ë²„íŠ¼ ì—†ìŒ) -->
    <div class="info-panel">
        <div class="info-row">
            <label>ìœ„ë„:</label>
            <span id="lat">0.000000</span>
        </div>
        <div class="info-row">
            <label>ê²½ë„:</label>
            <span id="lng">0.000000</span>
        </div>
        <div class="info-row accuracy">
            <label>ì •í™•ë„:</label>
            <span id="accuracy">N/A</span>
        </div>
        <div class="info-row status">
            <label>ìƒíƒœ:</label>
            <span id="status">ëŒ€ê¸°ì¤‘</span>
        </div>
        <div class="info-row">
            <label>í¬ì¸íŠ¸:</label>
            <span id="pointCount">0</span>ê°œ
        </div>
        <div class="info-row distance">
            <label>ê±°ë¦¬:</label>
            <span id="distance">0</span>m
        </div>
    </div>

    <script>
        // ============= í”Œë¡œíŒ… ëª¨ë“œ ê°ì§€ =============
        const urlParams = new URLSearchParams(window.location.search);
        const isFloatingMode = urlParams.get('floating') === 'true';
        
        if (isFloatingMode) {
            console.log('ğŸ”„ FLOATING MODE ACTIVATED');
        }
        
        // ============= ìƒíƒœ ë³´ì¡´ ì‹œìŠ¤í…œ =============
        const StateManager = {
            STORAGE_KEY: 'naverMapState',
            
            saveState: function() {
                if (typeof map === 'undefined' || !map) return false;
                
                const state = {
                    center: map ? {
                        lat: map.getCenter().lat(),
                        lng: map.getCenter().lng()
                    } : null,
                    zoom: map ? map.getZoom() : 16,
                    isTracking: isTracking,
                    routeCoordinates: routeCoordinates.map(coord => ({
                        lat: coord.lat(),
                        lng: coord.lng()
                    })),
                    totalDistance: totalDistance,
                    lastUpdate: new Date().toISOString(),
                    isFloating: isFloatingMode
                };
                
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(state));
                    return true;
                } catch (e) {
                    console.error('Failed to save state:', e);
                    return false;
                }
            },
            
            restoreState: function() {
                try {
                    const savedState = localStorage.getItem(this.STORAGE_KEY);
                    if (!savedState) return null;
                    
                    const state = JSON.parse(savedState);
                    console.log('State restored:', state);
                    return state;
                } catch (e) {
                    console.error('Failed to restore state:', e);
                    return null;
                }
            },
            
            clearState: function() {
                try {
                    localStorage.removeItem(this.STORAGE_KEY);
                    console.log('State cleared');
                } catch (e) {
                    console.error('Failed to clear state:', e);
                }
            }
        };

        // ============= ì „ì—­ ë³€ìˆ˜ =============
        let map;
        let userMarker = null;
        let routePath = null;
        let routeCoordinates = [];
        let isTracking = false;
        let startMarker = null;
        let endMarker = null;
        let totalDistance = 0;
        let autoStartTriggered = false;

        // ============= Unity ë¸Œë¦¿ì§€ ê°ì²´ =============
        window.NaverMapBridge = {
            userLocation: null,
            isTrackingFromUnity: false,
            map: null,
            
            saveState: function() {
                return StateManager.saveState();
            },
            
            restoreState: function() {
                const state = StateManager.restoreState();
                if (state) {
                    applyRestoredState(state);
                }
                return state;
            },
            
            // â­ Unityì—ì„œ ì¶”ì  ìƒíƒœ ì„¤ì •
            setTrackingState: function(state) {
                console.log('Unity tracking state:', state);
                this.isTrackingFromUnity = state;
                if (state) {
                    startTracking();
                } else {
                    stopTracking();
                }
            },
            
            updateLocation: function(lat, lng, accuracy) {
                console.log('GPS from Plugin:', lat, lng, accuracy);
                
                if (typeof naver === 'undefined' || !naver.maps) {
                    console.error('Naver Maps not loaded yet');
                    return;
                }
                
                this.userLocation = new naver.maps.LatLng(lat, lng);
                
                // í”Œë¡œíŒ… ëª¨ë“œì—ì„œ ì²« GPS ìˆ˜ì‹ ì‹œ ìë™ ì¶”ì  ì‹œì‘
                if (isFloatingMode && !isTracking && !autoStartTriggered && this.userLocation) {
                    console.log('ğŸš€ Auto-starting tracking in floating mode');
                    autoStartTriggered = true;
                    startTracking();
                    
                    if (map) {
                        map.setCenter(this.userLocation);
                        map.setZoom(17);
                    }
                }
                
                // ì‚¬ìš©ì ë§ˆì»¤ ì—…ë°ì´íŠ¸ (íŒŒë€ìƒ‰ í˜„ì¬ ìœ„ì¹˜)
                if (userMarker) {
                    userMarker.setPosition(this.userLocation);
                } else if (map) {
                    userMarker = new naver.maps.Marker({
                        position: this.userLocation,
                        map: map,
                        icon: {
                            content: '<div style="width:20px;height:20px;background:#4285F4;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                            anchor: new naver.maps.Point(13, 13)
                        },
                        zIndex: 100
                    });
                }
                
                // Unity ì¶”ì  ìƒíƒœì™€ ë™ê¸°í™”
                if (this.isTrackingFromUnity && !isTracking) {
                    startTracking();
                }
                
                // â­ ê²½ë¡œ ì¶”ì  ì¤‘ì´ë©´ ê²½ë¡œì— ì¶”ê°€
                if (isTracking) {
                    if (routeCoordinates.length === 0) {
                        // â­ ì²« ë²ˆì§¸ í¬ì¸íŠ¸: ì‹œì‘ ë§ˆì»¤ë„ í•¨ê»˜ ìƒì„±!
                        addFirstRoutePoint(lat, lng);
                    } else {
                        const lastPoint = routeCoordinates[routeCoordinates.length - 1];
                        const distance = calculateDistance(
                            lastPoint.lat(), lastPoint.lng(),
                            lat, lng
                        );
                        
                        const minDistance = isFloatingMode ? 2 : 3;
                        const maxDistance = 100;
                        
                        if (distance > minDistance && distance < maxDistance) {
                            addRoutePoint(lat, lng);
                            totalDistance += distance;
                            document.getElementById('distance').textContent = Math.round(totalDistance);
                        } else if (distance >= maxDistance) {
                            console.log('âš ï¸ GPS jump detected (' + Math.round(distance) + 'm), ignoring');
                        }
                    }
                }
                
                updateInfoPanel(lat, lng, accuracy);
                
                if (isFloatingMode || routeCoordinates.length % 5 === 0) {
                    StateManager.saveState();
                }
            },
            
            moveToLocation: function(lat, lng) {
                if (map && typeof naver !== 'undefined') {
                    map.setCenter(new naver.maps.LatLng(lat, lng));
                    StateManager.saveState();
                }
            },
            
            setZoom: function(level) {
                if (map) {
                    map.setZoom(level);
                    StateManager.saveState();
                }
            },
            
            // â­ Unityì—ì„œ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ë“¤
            startTracking: function() {
                startTracking();
            },
            
            stopTracking: function() {
                stopTracking();
            },
            
            clearRoute: function() {
                clearRoute();
            },
            
            // â­ ìƒˆë¡œ ì¶”ê°€: ë§ˆì»¤ë§Œ í´ë¦¬ì–´
            clearMarkers: function() {
                clearMarkers();
            },
            
            // â­ ìƒˆë¡œ ì¶”ê°€: ì‹œì‘ ë§ˆì»¤ ì¶”ê°€ (Unityì—ì„œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥)
            addStartMarker: function(lat, lng) {
                addStartMarkerAt(lat, lng);
            },
            
            // â­ ìƒˆë¡œ ì¶”ê°€: í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì—…ë°ì´íŠ¸ (Unityì—ì„œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥)
            updateCurrentLocation: function(lat, lng) {
                updateCurrentMarker(lat, lng);
            },
            
            addRoutePoint: function(lat, lng) {
                addRoutePoint(lat, lng);
            },
            
            drawRoute: function(pointsArray) {
                if (typeof naver === 'undefined' || !naver.maps) {
                    console.error('Naver Maps not loaded yet');
                    return;
                }
                
                if (!Array.isArray(pointsArray)) {
                    try {
                        pointsArray = JSON.parse(pointsArray);
                    } catch (e) {
                        console.error('Invalid route data:', e);
                        return;
                    }
                }
                
                routeCoordinates = [];
                pointsArray.forEach(p => {
                    routeCoordinates.push(new naver.maps.LatLng(p.lat, p.lng));
                });
                
                updateRoute();
                document.getElementById('pointCount').textContent = routeCoordinates.length;
            }
        };

        // ============= ì§€ë„ ì´ˆê¸°í™” =============
        function initMap() {
            if (typeof naver === 'undefined' || !naver.maps) {
                console.error('Naver Maps API not loaded');
                setTimeout(initMap, 500);
                return;
            }
            
            if (isFloatingMode) {
                document.body.classList.add('floating-mode');
                console.log('Floating mode UI applied');
            }
            
            const savedState = StateManager.restoreState();
            
            const floatingMapOptions = isFloatingMode ? {
                draggable: false,
                scrollWheel: false,
                disableDoubleClickZoom: true,
                disableDoubleTapZoom: true
            } : {};
            
            const mapOptions = {
                center: savedState && savedState.center ? 
                    new naver.maps.LatLng(savedState.center.lat, savedState.center.lng) : 
                    new naver.maps.LatLng(37.5665, 126.9780),
                zoom: savedState ? savedState.zoom : 16,
                mapTypeControl: false,
                scaleControl: false,
                logoControl: false,
                mapDataControl: false,
                zoomControl: !isFloatingMode,
                zoomControlOptions: {
                    position: naver.maps.Position.TOP_RIGHT
                },
                ...floatingMapOptions
            };

            map = new naver.maps.Map('map', mapOptions);
            window.NaverMapBridge.map = map;
            
            if (!isFloatingMode) {
                naver.maps.Event.addListener(map, 'dragend', function() {
                    StateManager.saveState();
                });
                
                naver.maps.Event.addListener(map, 'zoom_changed', function() {
                    StateManager.saveState();
                });
            }
            
            if (savedState) {
                applyRestoredState(savedState);
            }
            
            updateStatusDisplay();
            console.log('âœ… Map initialized successfully');
        }

        // ============= ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸ =============
        function updateStatusDisplay() {
            const statusEl = document.getElementById('status');
            if (isFloatingMode) {
                statusEl.textContent = isTracking ? 'í”Œë¡œíŒ… ì¶”ì ' : 'í”Œë¡œíŒ…';
                statusEl.className = isTracking ? 'status-tracking' : '';
            } else {
                statusEl.textContent = isTracking ? 'ì¶”ì  ì¤‘' : 'ëŒ€ê¸°ì¤‘';
                statusEl.className = isTracking ? 'status-tracking' : '';
            }
        }

        // ============= ì €ì¥ëœ ìƒíƒœ ì ìš© =============
        function applyRestoredState(state) {
            if (!state) return;
            if (typeof naver === 'undefined' || !naver.maps) return;
            
            if (state.routeCoordinates && state.routeCoordinates.length > 0) {
                routeCoordinates = state.routeCoordinates.map(p => 
                    new naver.maps.LatLng(p.lat, p.lng)
                );
                totalDistance = state.totalDistance || 0;
                
                updateRoute();
                
                if (routeCoordinates.length > 0) {
                    if (startMarker) startMarker.setMap(null);
                    startMarker = new naver.maps.Marker({
                        position: routeCoordinates[0],
                        map: map,
                        icon: {
                            content: '<div style="width:15px;height:15px;background:#00C73C;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                            anchor: new naver.maps.Point(9, 9)
                        },
                        zIndex: 90
                    });
                }
                
                document.getElementById('pointCount').textContent = routeCoordinates.length;
                document.getElementById('distance').textContent = Math.round(totalDistance);
            }
            
            if (state.isTracking) {
                isTracking = true;
                updateStatusDisplay();
            }
            
            console.log('State restored from:', state.lastUpdate);
        }

        // ============= â­ ìƒˆë¡œ ì¶”ê°€: ì²« ë²ˆì§¸ ê²½ë¡œ í¬ì¸íŠ¸ + ì‹œì‘ ë§ˆì»¤ =============
        function addFirstRoutePoint(lat, lng) {
            if (typeof naver === 'undefined' || !naver.maps) return;
            
            const point = new naver.maps.LatLng(lat, lng);
            routeCoordinates.push(point);
            
            // â­ ì‹œì‘ ë§ˆì»¤ (ë…¹ìƒ‰) ìƒì„±
            if (startMarker) {
                startMarker.setMap(null);
            }
            startMarker = new naver.maps.Marker({
                position: point,
                map: map,
                icon: {
                    content: '<div style="width:15px;height:15px;background:#00C73C;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                    anchor: new naver.maps.Point(9, 9)
                },
                zIndex: 90
            });
            
            // ì§€ë„ ì¤‘ì‹¬ ì´ë™
            map.setCenter(point);
            
            document.getElementById('pointCount').textContent = routeCoordinates.length;
            
            StateManager.saveState();
            console.log('ğŸŸ¢ FIRST point + START marker added:', lat, lng);
        }

        // ============= â­ ìƒˆë¡œ ì¶”ê°€: ì‹œì‘ ë§ˆì»¤ë§Œ ì¶”ê°€ =============
        function addStartMarkerAt(lat, lng) {
            if (typeof naver === 'undefined' || !naver.maps) return;
            
            const point = new naver.maps.LatLng(lat, lng);
            
            if (startMarker) {
                startMarker.setMap(null);
            }
            startMarker = new naver.maps.Marker({
                position: point,
                map: map,
                icon: {
                    content: '<div style="width:15px;height:15px;background:#00C73C;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                    anchor: new naver.maps.Point(9, 9)
                },
                zIndex: 90
            });
            
            console.log('ğŸŸ¢ Start marker added at:', lat, lng);
        }

        // ============= â­ ìƒˆë¡œ ì¶”ê°€: í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ì—…ë°ì´íŠ¸ =============
        function updateCurrentMarker(lat, lng) {
            if (typeof naver === 'undefined' || !naver.maps) return;
            
            const point = new naver.maps.LatLng(lat, lng);
            window.NaverMapBridge.userLocation = point;
            
            if (userMarker) {
                userMarker.setPosition(point);
            } else if (map) {
                userMarker = new naver.maps.Marker({
                    position: point,
                    map: map,
                    icon: {
                        content: '<div style="width:20px;height:20px;background:#4285F4;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                        anchor: new naver.maps.Point(13, 13)
                    },
                    zIndex: 100
                });
            }
            
            console.log('ğŸ”µ Current marker updated at:', lat, lng);
        }

        // ============= â­ ìƒˆë¡œ ì¶”ê°€: ë§ˆì»¤ë§Œ í´ë¦¬ì–´ =============
        function clearMarkers() {
            if (startMarker) {
                startMarker.setMap(null);
                startMarker = null;
            }
            
            if (endMarker) {
                endMarker.setMap(null);
                endMarker = null;
            }
            
            if (userMarker) {
                userMarker.setMap(null);
                userMarker = null;
            }
            
            console.log('All markers cleared');
        }

        // ============= ê²½ë¡œ ì¶”ì  í•¨ìˆ˜ë“¤ (Unityì—ì„œ í˜¸ì¶œ) =============
        function startTracking() {
            if (typeof naver === 'undefined' || !naver.maps) return;
            
            if (!isTracking) {
                isTracking = true;
                
                // â­ ìˆ˜ì •: routeCoordinatesê°€ ë¹„ì–´ìˆìœ¼ë©´ ì²« GPS ëŒ€ê¸°
                // (ì‹œì‘ ë§ˆì»¤ëŠ” ì²« GPS ìˆ˜ì‹  ì‹œ addFirstRoutePointì—ì„œ ìƒì„±)
                if (routeCoordinates.length === 0) {
                    totalDistance = 0;
                    console.log('ğŸŸ¢ Tracking started - waiting for first GPS...');
                }
                
                updateStatusDisplay();
                StateManager.saveState();
                console.log('Route tracking started' + (isFloatingMode ? ' [FLOATING]' : ''));
            }
        }

        function stopTracking() {
            if (typeof naver === 'undefined' || !naver.maps) return;
            
            if (isTracking) {
                isTracking = false;
                
                if (routeCoordinates.length > 0) {
                    if (endMarker) {
                        endMarker.setMap(null);
                    }
                    const lastPoint = routeCoordinates[routeCoordinates.length - 1];
                    endMarker = new naver.maps.Marker({
                        position: lastPoint,
                        map: map,
                        icon: {
                            content: '<div style="width:15px;height:15px;background:#FF3E3E;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                            anchor: new naver.maps.Point(9, 9)
                        },
                        zIndex: 90
                    });
                }
                
                updateStatusDisplay();
                StateManager.saveState();
                console.log('Route tracking stopped');
            }
        }

        function addRoutePoint(lat, lng) {
            if (typeof naver === 'undefined' || !naver.maps) return;
            
            const point = new naver.maps.LatLng(lat, lng);
            routeCoordinates.push(point);
            
            updateRoute();
            
            document.getElementById('pointCount').textContent = routeCoordinates.length;
            
            if (isFloatingMode || routeCoordinates.length % 5 === 0) {
                StateManager.saveState();
            }
            
            console.log('Point added:', lat, lng, 'Total:', routeCoordinates.length);
        }

        function clearRoute() {
            routeCoordinates = [];
            isTracking = false;
            totalDistance = 0;
            
            if (routePath) {
                routePath.setMap(null);
                routePath = null;
            }
            
            if (startMarker) {
                startMarker.setMap(null);
                startMarker = null;
            }
            
            if (endMarker) {
                endMarker.setMap(null);
                endMarker = null;
            }
            
            // â­ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ë„ í´ë¦¬ì–´
            if (userMarker) {
                userMarker.setMap(null);
                userMarker = null;
            }
            
            document.getElementById('pointCount').textContent = '0';
            document.getElementById('distance').textContent = '0';
            updateStatusDisplay();
            
            StateManager.clearState();
            console.log('Route cleared (including all markers)');
        }

        // ============= ê²½ë¡œ ê·¸ë¦¬ê¸° (ì§ì„  ì—°ê²°ë¡œ ìˆ˜ì •) =============
        function updateRoute() {
            if (typeof naver === 'undefined' || !naver.maps) {
                console.error('Naver Maps not loaded yet');
                return;
            }
            
            if (routePath) {
                routePath.setMap(null);
            }
            
            if (routeCoordinates.length > 1) {
                // âœ… ìˆ˜ì •: ìŠ¤ë¬´ë”© ì œê±°, ì›ë³¸ GPS í¬ì¸íŠ¸ ì‚¬ìš©
                var pathToRender = routeCoordinates;
                
                routePath = new naver.maps.Polyline({
                    map: map,
                    path: pathToRender,
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.8,
                    strokeWeight: isFloatingMode ? 3 : 5,
                    strokeLineCap: 'butt',      // âœ… round â†’ butt
                    strokeLineJoin: 'miter'     // âœ… round â†’ miter
                });
                
                console.log('Route updated: ' + routeCoordinates.length + ' points');
            }
        }
        
        // ë¶€ë“œëŸ¬ìš´ ë¼ì¸ì„ ìœ„í•œ ìŠ¤ë¬´ë”© í•¨ìˆ˜ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - ë‚˜ì¤‘ì„ ìœ„í•´ ë³´ê´€)
        function smoothPointsSafe(points) {
            if (typeof naver === 'undefined' || !naver.maps) {
                return points;
            }
            
            if (points.length < 3) return points;
            
            var smoothed = [];
            smoothed.push(points[0]);
            
            for (var i = 1; i < points.length - 1; i++) {
                var prev = points[i - 1];
                var curr = points[i];
                var next = points[i + 1];
                
                var avgLat = (prev.lat() + curr.lat() + next.lat()) / 3;
                var avgLng = (prev.lng() + curr.lng() + next.lng()) / 3;
                
                var lastSmoothed = smoothed[smoothed.length - 1];
                var midLat = (lastSmoothed.lat() + avgLat) / 2;
                var midLng = (lastSmoothed.lng() + avgLng) / 2;
                
                smoothed.push(new naver.maps.LatLng(midLat, midLng));
                smoothed.push(new naver.maps.LatLng(avgLat, avgLng));
            }
            
            smoothed.push(points[points.length - 1]);
            
            return smoothed;
        }

        // ============= ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ =============
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateInfoPanel(lat, lng, accuracy) {
            if (isFloatingMode) {
                document.getElementById('lat').textContent = lat.toFixed(4);
                document.getElementById('lng').textContent = lng.toFixed(4);
                document.getElementById('pointCount').textContent = routeCoordinates.length;
            } else {
                document.getElementById('lat').textContent = lat.toFixed(6);
                document.getElementById('lng').textContent = lng.toFixed(6);
                document.getElementById('accuracy').textContent = accuracy ? accuracy.toFixed(1) + 'm' : 'N/A';
            }
        }

        // ============= ìŠ¤ì™€ì´í”„ ë°©ì§€ =============
        let touchStartX = 0;
        let touchStartY = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: false });
        
        document.addEventListener('touchmove', function(e) {
            if (!e.target.closest('#map')) {
                e.preventDefault();
                return false;
            }
            
            const deltaX = Math.abs(e.touches[0].clientX - touchStartX);
            const deltaY = Math.abs(e.touches[0].clientY - touchStartY);
            
            if (isFloatingMode) {
                e.preventDefault();
                return false;
            }
            
            if (deltaX > deltaY && deltaX > 50) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }, { passive: false });
        
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function() {
            window.history.go(1);
        };

        // ============= í˜ì´ì§€ ì´ë²¤íŠ¸ =============
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                StateManager.saveState();
                console.log('Page hidden - state saved');
            } else {
                const state = StateManager.restoreState();
                if (state) {
                    console.log('Page visible - state restored');
                }
            }
        });

        window.addEventListener('beforeunload', function() {
            StateManager.saveState();
        });

        // ============= ì „ì—­ í•¨ìˆ˜ ë“±ë¡ (Unityìš©) =============
        window.startRoute = startTracking;
        window.stopRoute = stopTracking;
        window.clearRoute = clearRoute;
        window.addRoutePoint = addRoutePoint;
        window.clearMarkers = clearMarkers;
        window.addStartMarker = addStartMarkerAt;
        window.updateCurrentLocation = updateCurrentMarker;
        
        window.restoreRoute = function(pointsJson) {
            if (typeof naver === 'undefined' || !naver.maps) {
                console.error('Naver Maps not loaded yet');
                return;
            }
            
            try {
                const points = typeof pointsJson === 'string' ? JSON.parse(pointsJson) : pointsJson;
                routeCoordinates = [];
                totalDistance = 0;
                
                points.forEach((p, index) => {
                    const point = new naver.maps.LatLng(p.lat, p.lng);
                    routeCoordinates.push(point);
                    
                    if (index > 0) {
                        const prevPoint = routeCoordinates[index - 1];
                        totalDistance += calculateDistance(
                            prevPoint.lat(), prevPoint.lng(),
                            point.lat(), point.lng()
                        );
                    }
                });
                
                updateRoute();
                
                if (routeCoordinates.length > 0) {
                    if (startMarker) startMarker.setMap(null);
                    startMarker = new naver.maps.Marker({
                        position: routeCoordinates[0],
                        map: map,
                        icon: {
                            content: '<div style="width:15px;height:15px;background:#00C73C;border-radius:50%;border:2px solid white;"></div>',
                            anchor: new naver.maps.Point(9, 9)
                        }
                    });
                    
                    if (!isTracking && routeCoordinates.length > 1) {
                        if (endMarker) endMarker.setMap(null);
                        endMarker = new naver.maps.Marker({
                            position: routeCoordinates[routeCoordinates.length - 1],
                            map: map,
                            icon: {
                                content: '<div style="width:15px;height:15px;background:#FF3E3E;border-radius:50%;border:2px solid white;"></div>',
                                anchor: new naver.maps.Point(9, 9)
                            }
                        });
                    }
                }
                
                document.getElementById('pointCount').textContent = routeCoordinates.length;
                document.getElementById('distance').textContent = Math.round(totalDistance);
                
                StateManager.saveState();
                console.log('Restored', routeCoordinates.length, 'points');
            } catch (e) {
                console.error('Failed to restore route:', e);
            }
        };

        // ============= ì´ˆê¸°í™” ì‹¤í–‰ =============
        window.onload = function() {
            if (typeof naver !== 'undefined' && naver.maps) {
                initMap();
            } else {
                console.log('Waiting for Naver Maps API...');
                setTimeout(initMap, 500);
            }
            console.log('Map initialization started' + (isFloatingMode ? ' [FLOATING MODE]' : ' [NORMAL MODE]'));
        };


// ============= ì „ì²´ ê²½ë¡œ ìº¡ì²˜ ì‹œìŠ¤í…œ =============

// ìº¡ì²˜ ìƒíƒœ ë³€ìˆ˜
let captureState = {
    isCapturing: false,
    tiles: [],           // ìº¡ì²˜í•  íƒ€ì¼ ì •ë³´ [{lat, lng, index}]
    currentTileIndex: 0,
    originalCenter: null,
    originalZoom: null,
    captureZoom: 16,     // ìº¡ì²˜ ì‹œ ì¤Œ ë ˆë²¨ (ë†’ì„ìˆ˜ë¡ ìƒì„¸)
    tileOverlap: 0.1     // íƒ€ì¼ ê°„ 10% ê²¹ì¹¨ (ì´ìŒìƒˆ ë°©ì§€)
};

/**
 * â­ Unityì—ì„œ í˜¸ì¶œ - ì „ì²´ ê²½ë¡œ ê³ í•´ìƒë„ ìº¡ì²˜ ì‹œì‘
 */
window.NaverMapBridge.startFullRouteCapture = function(zoom) {
    if (captureState.isCapturing) {
        console.log('Already capturing...');
        return;
    }
    
    if (routeCoordinates.length < 2) {
        console.log('No route to capture');
        if (window.Unity) {
            window.Unity.call('N/CAPTURE_ERROR:No route data');
        }
        return;
    }
    
    console.log('ğŸ¬ Starting full route capture...');
    captureState.isCapturing = true;
    captureState.captureZoom = zoom || 16;
    
    // í˜„ì¬ ìƒíƒœ ì €ì¥ (ë‚˜ì¤‘ì— ë³µì›ìš©)
    captureState.originalCenter = map.getCenter();
    captureState.originalZoom = map.getZoom();
    
    // ìº¡ì²˜í•  íƒ€ì¼ ê³„ì‚°
    calculateCaptureTiles();
    
    // ì²« ë²ˆì§¸ íƒ€ì¼ë¶€í„° ìº¡ì²˜ ì‹œì‘
    captureState.currentTileIndex = 0;
    
    // Unityì— íƒ€ì¼ ì •ë³´ ì „ë‹¬
    var info = {
        totalTiles: captureState.tiles.length,
        zoom: captureState.captureZoom,
        cols: captureState.cols,
        rows: captureState.rows
    };
    
    console.log('Capture info:', info);
    
    if (window.Unity) {
        window.Unity.call('N/CAPTURE_START:' + JSON.stringify(info));
    }
    
    // ì²« íƒ€ì¼ë¡œ ì´ë™
    moveToNextTile();
};

/**
 * ê²½ë¡œ ë²”ìœ„ ê¸°ë°˜ìœ¼ë¡œ ìº¡ì²˜í•  íƒ€ì¼ ê³„ì‚°
 */
function calculateCaptureTiles() {
    // ê²½ë¡œ ë²”ìœ„ ê³„ì‚°
    var bounds = new naver.maps.LatLngBounds();
    routeCoordinates.forEach(function(coord) {
        bounds.extend(coord);
    });
    
    var sw = bounds.getSW();  // ë‚¨ì„œìª½ (min lat, min lng)
    var ne = bounds.getNE();  // ë¶ë™ìª½ (max lat, max lng)
    
    console.log('Route bounds:', sw.lat(), sw.lng(), 'to', ne.lat(), ne.lng());
    
    // ì¤Œ ë ˆë²¨ì—ì„œ í•œ í™”ë©´ì— ë³´ì´ëŠ” ë²”ìœ„ ê³„ì‚° (ë¯¸í„°)
    var metersPerPixel = getMetersPerPixelAtZoom(captureState.captureZoom);
    var screenWidthMeters = metersPerPixel * window.innerWidth;
    var screenHeightMeters = metersPerPixel * window.innerHeight;
    
    // ê²¹ì¹¨ ì ìš©
    var effectiveWidth = screenWidthMeters * (1 - captureState.tileOverlap);
    var effectiveHeight = screenHeightMeters * (1 - captureState.tileOverlap);
    
    // ë¯¸í„° â†’ ìœ„ë„/ê²½ë„ ë³€í™˜
    var latPerTile = effectiveHeight / 111000;
    var lngPerTile = effectiveWidth / (111000 * Math.cos(((sw.lat() + ne.lat()) / 2) * Math.PI / 180));
    
    // í•„ìš”í•œ í–‰/ì—´ ìˆ˜ ê³„ì‚°
    var latRange = ne.lat() - sw.lat();
    var lngRange = ne.lng() - sw.lng();
    
    // ë§ˆì§„ ì¶”ê°€ (ê²½ë¡œê°€ ê°€ì¥ìë¦¬ì— ê±¸ë¦¬ì§€ ì•Šë„ë¡)
    var marginLat = latPerTile * 0.3;
    var marginLng = lngPerTile * 0.3;
    
    var cols = Math.ceil((lngRange + marginLng * 2) / lngPerTile);
    var rows = Math.ceil((latRange + marginLat * 2) / latPerTile);
    
    // ìµœì†Œ/ìµœëŒ€ ì œí•œ
    cols = Math.max(1, Math.min(cols, 5));  // 1~5ì—´
    rows = Math.max(1, Math.min(rows, 5));  // 1~5í–‰
    
    captureState.cols = cols;
    captureState.rows = rows;
    
    console.log('Grid:', cols, 'x', rows, '=', cols * rows, 'tiles');
    
    // íƒ€ì¼ ì¤‘ì‹¬ì  ê³„ì‚°
    captureState.tiles = [];
    
    var startLat = sw.lat() - marginLat + (latPerTile / 2);
    var startLng = sw.lng() - marginLng + (lngPerTile / 2);
    
    var index = 0;
    for (var row = 0; row < rows; row++) {
        for (var col = 0; col < cols; col++) {
            var tileLat = startLat + (row * latPerTile);
            var tileLng = startLng + (col * lngPerTile);
            
            captureState.tiles.push({
                lat: tileLat,
                lng: tileLng,
                row: row,
                col: col,
                index: index++
            });
        }
    }
    
    console.log('Tiles calculated:', captureState.tiles.length);
}

/**
 * ì¤Œ ë ˆë²¨ë³„ ë¯¸í„°/í”½ì…€ ë°˜í™˜
 */
function getMetersPerPixelAtZoom(zoom) {
    var metersPerPixel = {
        10: 76,
        11: 38,
        12: 19,
        13: 9.5,
        14: 4.8,
        15: 2.4,
        16: 1.2,
        17: 0.6,
        18: 0.3
    };
    return metersPerPixel[zoom] || 2.4;
}

/**
 * ë‹¤ìŒ íƒ€ì¼ë¡œ ì´ë™
 */
function moveToNextTile() {
    if (captureState.currentTileIndex >= captureState.tiles.length) {
        // ëª¨ë“  íƒ€ì¼ ì™„ë£Œ
        finishCapture();
        return;
    }
    
    var tile = captureState.tiles[captureState.currentTileIndex];
    console.log('Moving to tile', tile.index + 1, '/', captureState.tiles.length);
    
    // ì§€ë„ ì´ë™
    map.setZoom(captureState.captureZoom);
    map.setCenter(new naver.maps.LatLng(tile.lat, tile.lng));
    
    // íƒ€ì¼ ë¡œë”© ëŒ€ê¸° í›„ ìº¡ì²˜ ìš”ì²­
    setTimeout(function() {
        requestTileCapture(tile);
    }, 1200);  // 1.2ì´ˆ ëŒ€ê¸° (íƒ€ì¼ ë¡œë”©)
}

/**
 * í˜„ì¬ íƒ€ì¼ ìº¡ì²˜ ìš”ì²­ (Unity/Javaì— ì „ë‹¬)
 */
function requestTileCapture(tile) {
    var data = {
        index: tile.index,
        row: tile.row,
        col: tile.col,
        total: captureState.tiles.length
    };
    
    console.log('Requesting capture for tile:', data);
    
    if (window.Unity) {
        window.Unity.call('N/CAPTURE_TILE:' + JSON.stringify(data));
    }
}

/**
 * â­ Unityì—ì„œ í˜¸ì¶œ - íƒ€ì¼ ìº¡ì²˜ ì™„ë£Œ ì•Œë¦¼
 */
window.NaverMapBridge.onTileCaptured = function(tileIndex) {
    console.log('Tile captured:', tileIndex);
    
    // ë‹¤ìŒ íƒ€ì¼ë¡œ
    captureState.currentTileIndex++;
    
    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    var progress = Math.round((captureState.currentTileIndex / captureState.tiles.length) * 100);
    if (window.Unity) {
        window.Unity.call('N/CAPTURE_PROGRESS:' + progress);
    }
    
    // ë‹¤ìŒ íƒ€ì¼ ì§„í–‰
    moveToNextTile();
};

/**
 * ìº¡ì²˜ ì™„ë£Œ ì²˜ë¦¬
 */
function finishCapture() {
    console.log('ğŸ¬ All tiles captured!');
    
    // ì›ë˜ ìƒíƒœë¡œ ë³µì›
    if (captureState.originalCenter && captureState.originalZoom) {
        map.setCenter(captureState.originalCenter);
        map.setZoom(captureState.originalZoom);
    }
    
    captureState.isCapturing = false;
    
    // Unityì— ì™„ë£Œ ì•Œë¦¼ (Javaì—ì„œ ì´ë¯¸ì§€ í•©ì¹˜ê¸° ì‹œì‘)
    if (window.Unity) {
        window.Unity.call('N/CAPTURE_COMPLETE:' + JSON.stringify({
            cols: captureState.cols,
            rows: captureState.rows,
            total: captureState.tiles.length
        }));
    }
}

/**
 * ìº¡ì²˜ ì·¨ì†Œ
 */
window.NaverMapBridge.cancelCapture = function() {
    if (captureState.isCapturing) {
        captureState.isCapturing = false;
        
        // ì›ë˜ ìƒíƒœ ë³µì›
        if (captureState.originalCenter && captureState.originalZoom) {
            map.setCenter(captureState.originalCenter);
            map.setZoom(captureState.originalZoom);
        }
        
        console.log('Capture cancelled');
    }
};

        
    </script>
</body>
</html>
