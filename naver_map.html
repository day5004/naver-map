<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Naver Map with Floating Support</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=0lep6flysx"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            overflow: hidden;
            touch-action: none;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            touch-action: manipulation;
        }
        
        .info-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 11px;
            min-width: 150px;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .info-panel.capture-hidden {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
        
        .info-row {
            margin: 2px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .info-row span {
            font-weight: bold;
            color: #333;
        }
        
        .status-tracking {
            color: #03CF5D !important;
        }
        
        .floating-mode .info-panel {
            position: fixed;
            top: 5px;
            right: 5px;
            bottom: auto;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 9px !important;
            padding: 4px 6px;
            min-width: 80px;
            border-radius: 4px;
        }
        
        .floating-mode .info-row label {
            color: #aaa;
            font-size: 8px;
        }
        
        .floating-mode .info-row span {
            color: #fff;
            font-size: 9px;
        }
        
        .floating-mode .info-row.accuracy,
        .floating-mode .info-row.distance {
            display: none;
        }
        
        /* ‚≠ê ÏãùÎ¨º ÎßàÏª§ ÌïòÏù¥ÎùºÏù¥Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            25% {
                transform: translateY(-15px);
            }
            50% {
                transform: translateY(0);
            }
            75% {
                transform: translateY(-8px);
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .plant-marker-highlight {
            animation: pulse 0.5s ease-in-out 3;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info-panel" id="info-panel">
        <div class="info-row">
            <label>ÏúÑÎèÑ:</label>
            <span id="lat">0.000000</span>
        </div>
        <div class="info-row">
            <label>Í≤ΩÎèÑ:</label>
            <span id="lng">0.000000</span>
        </div>
        <div class="info-row accuracy">
            <label>Ï†ïÌôïÎèÑ:</label>
            <span id="accuracy">N/A</span>
        </div>
        <div class="info-row status">
            <label>ÏÉÅÌÉú:</label>
            <span id="status">ÎåÄÍ∏∞Ï§ë</span>
        </div>
        <div class="info-row">
            <label>Ìè¨Ïù∏Ìä∏:</label>
            <span id="pointCount">0</span>Í∞ú
        </div>
        <div class="info-row distance">
            <label>Í±∞Î¶¨:</label>
            <span id="distance">0</span>m
        </div>
    </div>

    <script>
        // Unity ÌÜµÏã† Î∏åÎ¶øÏßÄ
        window.Unity = {
            call: function(message) {
                console.log('Unity call:', message);
                try {
                    window.location.href = 'toapp://' + encodeURIComponent(message);
                } catch (e) {
                    console.error('Unity call error:', e);
                }
            }
        };
        
        const urlParams = new URLSearchParams(window.location.search);
        const isFloatingMode = urlParams.get('floating') === 'true';
        
        if (isFloatingMode) {
            console.log('FLOATING MODE ACTIVATED');
        }
        
        // ÏÉÅÌÉú Î≥¥Ï°¥
        const StateManager = {
            STORAGE_KEY: 'naverMapState',
            
            saveState: function() {
                if (typeof map === 'undefined' || !map) return false;
                const state = {
                    center: { lat: map.getCenter().lat(), lng: map.getCenter().lng() },
                    zoom: map.getZoom(),
                    isTracking: isTracking,
                    routeCoordinates: routeCoordinates.map(coord => ({ lat: coord.lat(), lng: coord.lng() })),
                    totalDistance: totalDistance,
                    lastUpdate: new Date().toISOString()
                };
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(state));
                    return true;
                } catch (e) { return false; }
            },
            
            restoreState: function() {
                try {
                    const savedState = localStorage.getItem(this.STORAGE_KEY);
                    return savedState ? JSON.parse(savedState) : null;
                } catch (e) { return null; }
            },
            
            clearState: function() {
                try { localStorage.removeItem(this.STORAGE_KEY); } catch (e) {}
            }
        };

        let map;
        let userMarker = null;
        let routePath = null;
        let routeCoordinates = [];
        let isTracking = false;
        let startMarker = null;
        let endMarker = null;
        let totalDistance = 0;
        let autoStartTriggered = false;

        window.NaverMapBridge = {
            userLocation: null,
            isTrackingFromUnity: false,
            map: null,
            
            // ==================== ÏãùÎ¨º ÎßàÏª§ ÏãúÏä§ÌÖú ====================
            
            // ÏãùÎ¨º ÎßàÏª§ Ï†ÄÏû•Ïö©
            plantMarkers: {},
            
            // ÏãùÎ¨º Ï†ïÎ≥¥Ï∞Ω
            plantInfoWindow: null,
            
            // ÏãùÎ¨º ÏïÑÏù¥ÏΩò Ïù¥ÎØ∏ÏßÄ (SVG)
            plantIcons: {
                seed: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                    '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">' +
                    '<circle cx="16" cy="16" r="14" fill="#8B4513" stroke="#5D3A1A" stroke-width="2"/>' +
                    '<text x="16" y="22" text-anchor="middle" font-size="16">üå±</text>' +
                    '</svg>'
                ),
                sprout: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                    '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36">' +
                    '<circle cx="18" cy="18" r="16" fill="#228B22" stroke="#1B5E20" stroke-width="2"/>' +
                    '<text x="18" y="25" text-anchor="middle" font-size="20">üåø</text>' +
                    '</svg>'
                ),
                tree: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                    '<svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 44 44">' +
                    '<circle cx="22" cy="22" r="20" fill="#006400" stroke="#004D00" stroke-width="2"/>' +
                    '<text x="22" y="30" text-anchor="middle" font-size="24">üå≥</text>' +
                    '</svg>'
                )
            },
            
            addPlantMarker: function(id, lat, lng, icon, visitCount) {
                if (!this.map) { console.error('[NaverMapBridge] Map not initialized'); return; }
                if (this.plantMarkers[id]) { this.plantMarkers[id].setMap(null); }
                var iconSize;
                switch(icon) {
                    case 'seed': iconSize = new naver.maps.Size(32, 32); break;
                    case 'sprout': iconSize = new naver.maps.Size(36, 36); break;
                    case 'tree': iconSize = new naver.maps.Size(44, 44); break;
                    default: iconSize = new naver.maps.Size(32, 32);
                }
                var marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(lat, lng),
                    map: this.map,
                    icon: {
                        url: this.plantIcons[icon] || this.plantIcons.seed,
                        size: iconSize,
                        anchor: new naver.maps.Point(iconSize.width / 2, iconSize.height / 2)
                    },
                    title: 'Î∞©Î¨∏: ' + visitCount + 'Ìöå',
                    zIndex: 80
                });
                var self = this;
                naver.maps.Event.addListener(marker, 'click', function() {
                    self.showPlantInfo(id, lat, lng, icon, visitCount);
                });
                this.plantMarkers[id] = marker;
                console.log('[NaverMapBridge] Plant marker added:', id, icon);
            },
            
            updatePlantMarker: function(id, icon, visitCount) {
                var marker = this.plantMarkers[id];
                if (!marker) { console.warn('[NaverMapBridge] Marker not found:', id); return; }
                var iconSize;
                switch(icon) {
                    case 'seed': iconSize = new naver.maps.Size(32, 32); break;
                    case 'sprout': iconSize = new naver.maps.Size(36, 36); break;
                    case 'tree': iconSize = new naver.maps.Size(44, 44); break;
                    default: iconSize = new naver.maps.Size(32, 32);
                }
                marker.setIcon({
                    url: this.plantIcons[icon] || this.plantIcons.seed,
                    size: iconSize,
                    anchor: new naver.maps.Point(iconSize.width / 2, iconSize.height / 2)
                });
                marker.setTitle('Î∞©Î¨∏: ' + visitCount + 'Ìöå');
                console.log('[NaverMapBridge] Plant marker updated:', id, icon);
            },
            
            removePlantMarker: function(id) {
                var marker = this.plantMarkers[id];
                if (marker) {
                    marker.setMap(null);
                    delete this.plantMarkers[id];
                    console.log('[NaverMapBridge] Plant marker removed:', id);
                }
            },
            
            clearPlantMarkers: function() {
                for (var id in this.plantMarkers) {
                    if (this.plantMarkers.hasOwnProperty(id)) {
                        this.plantMarkers[id].setMap(null);
                    }
                }
                this.plantMarkers = {};
                console.log('[NaverMapBridge] All plant markers cleared');
            },
            
            showPlantInfo: function(id, lat, lng, icon, visitCount) {
                if (this.plantInfoWindow) { this.plantInfoWindow.close(); }
                var stageText, nextText;
                switch(icon) {
                    case 'seed': 
                        stageText = 'üå± Ïî®Ïïó'; 
                        nextText = 'Îã§Ïùå Îã®Í≥ÑÍπåÏßÄ ' + Math.max(0, 3 - visitCount) + 'Ìöå Î∞©Î¨∏';
                        break;
                    case 'sprout': 
                        stageText = 'üåø ÏÉàÏãπ'; 
                        nextText = 'Îã§Ïùå Îã®Í≥ÑÍπåÏßÄ ' + Math.max(0, 10 - visitCount) + 'Ìöå Î∞©Î¨∏';
                        break;
                    case 'tree': 
                        stageText = 'üå≥ ÎÇòÎ¨¥'; 
                        nextText = 'ÏµúÎåÄ ÏÑ±Ïû• ÏôÑÎ£å!';
                        break;
                    default: 
                        stageText = 'üå± Ïî®Ïïó';
                        nextText = '';
                }
                var content = 
                    '<div style="padding: 10px; min-width: 150px; text-align: center;">' +
                    '<div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">' + stageText + '</div>' +
                    '<div style="font-size: 14px; color: #666; margin-bottom: 4px;">Î∞©Î¨∏ ÌöüÏàò: ' + visitCount + 'Ìöå</div>' +
                    '<div style="font-size: 12px; color: #888;">' + nextText + '</div>' +
                    '</div>';
                this.plantInfoWindow = new naver.maps.InfoWindow({
                    content: content,
                    borderWidth: 1,
                    borderColor: '#2E7D32',
                    backgroundColor: '#fff',
                    anchorSize: new naver.maps.Size(10, 10)
                });
                this.plantInfoWindow.open(this.map, this.plantMarkers[id]);
            },
            
            highlightPlantMarker: function(id) {
                var marker = this.plantMarkers[id];
                if (!marker) { console.warn('[NaverMapBridge] Marker not found for highlight:', id); return; }
                console.log('[NaverMapBridge] Highlighting plant marker:', id);
                var position = marker.getPosition();
                if (this.map) { this.map.panTo(position); }
                var markerElement = marker.getElement();
                if (markerElement) {
                    markerElement.style.animation = 'none';
                    setTimeout(function() { markerElement.style.animation = 'bounce 0.5s ease-in-out 3'; }, 10);
                    setTimeout(function() { markerElement.style.animation = 'none'; }, 1600);
                }
            },
            
            moveToNearestPlant: function(lat, lng) {
                var nearestId = null;
                var nearestDistance = Infinity;
                for (var id in this.plantMarkers) {
                    if (this.plantMarkers.hasOwnProperty(id)) {
                        var marker = this.plantMarkers[id];
                        var pos = marker.getPosition();
                        var distance = this.calculatePlantDistance(lat, lng, pos.lat(), pos.lng());
                        if (distance < nearestDistance) {
                            nearestDistance = distance;
                            nearestId = id;
                        }
                    }
                }
                if (nearestId) {
                    var marker = this.plantMarkers[nearestId];
                    this.map.setCenter(marker.getPosition());
                    this.map.setZoom(17);
                    this.highlightPlantMarker(nearestId);
                    console.log('[NaverMapBridge] Moved to nearest plant:', nearestId, nearestDistance.toFixed(0) + 'm');
                }
            },
            
            calculatePlantDistance: function(lat1, lng1, lat2, lng2) {
                var R = 6371000;
                var dLat = (lat2 - lat1) * Math.PI / 180;
                var dLng = (lng2 - lng1) * Math.PI / 180;
                var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng/2) * Math.sin(dLng/2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },
            
            // ==================== Í∏∞Ï°¥ Î©îÏÑúÎìúÎì§ ====================
            
            saveState: function() { return StateManager.saveState(); },
            restoreState: function() {
                const state = StateManager.restoreState();
                if (state) applyRestoredState(state);
                return state;
            },
            
            setTrackingState: function(state) {
                this.isTrackingFromUnity = state;
                if (state) startTracking();
                else stopTracking();
            },
            
            updateLocation: function(lat, lng, accuracy) {
                if (typeof naver === 'undefined' || !naver.maps) return;
                
                this.userLocation = new naver.maps.LatLng(lat, lng);
                
                if (isFloatingMode && !isTracking && !autoStartTriggered && this.userLocation) {
                    autoStartTriggered = true;
                    startTracking();
                    if (map) {
                        map.setCenter(this.userLocation);
                        map.setZoom(17);
                    }
                }
                
                if (userMarker) {
                    userMarker.setPosition(this.userLocation);
                } else if (map) {
                    userMarker = new naver.maps.Marker({
                        position: this.userLocation,
                        map: map,
                        icon: {
                            content: '<div style="width:20px;height:20px;background:#4285F4;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                            anchor: new naver.maps.Point(13, 13)
                        },
                        zIndex: 100
                    });
                }
                
                if (this.isTrackingFromUnity && !isTracking) startTracking();
                
                if (isTracking) {
                    if (routeCoordinates.length === 0) {
                        addFirstRoutePoint(lat, lng);
                    } else {
                        const lastPoint = routeCoordinates[routeCoordinates.length - 1];
                        const distance = calculateDistance(lastPoint.lat(), lastPoint.lng(), lat, lng);
                        const minDistance = isFloatingMode ? 2 : 3;
                        if (distance > minDistance && distance < 500) {
                            addRoutePoint(lat, lng);
                            totalDistance += distance;
                            document.getElementById('distance').textContent = Math.round(totalDistance);
                        }
                    }
                }
                
                updateInfoPanel(lat, lng, accuracy);
                if (isFloatingMode || routeCoordinates.length % 5 === 0) StateManager.saveState();
            },
            
            moveToLocation: function(lat, lng) {
                if (map && typeof naver !== 'undefined') {
                    map.setCenter(new naver.maps.LatLng(lat, lng));
                }
            },
            
            setZoom: function(level) { if (map) map.setZoom(level); },
            startTracking: function() { startTracking(); },
            stopTracking: function() { stopTracking(); },
            clearRoute: function() { clearRoute(); },
            clearMarkers: function() { clearMarkers(); },
            addStartMarker: function(lat, lng) { addStartMarkerAt(lat, lng); },
            updateCurrentLocation: function(lat, lng) { updateCurrentMarker(lat, lng); },
            addRoutePoint: function(lat, lng) { addRoutePoint(lat, lng); },
            
            // ‚≠ê‚≠ê‚≠ê Î∂ÄÎìúÎü¨Ïö¥ Í≥°ÏÑ† Í≤ΩÎ°ú ÏãúÏä§ÌÖú ‚≠ê‚≠ê‚≠ê
            
            // ÏõêÎ≥∏ GPS Ìè¨Ïù∏Ìä∏ Ï†ÄÏû• (Î≥¥Í∞ÑÏö©)
            rawGPSPoints: [],
            
            // ‚≠ê Ïú†Ìö®Ìïú Ï¢åÌëúÏù∏ÏßÄ ÌôïÏù∏ (0,0 Î∞è ÌïúÍµ≠ Î≤îÏúÑ Î∞ñ ÌïÑÌÑ∞ÎßÅ)
            isValidCoordinate: function(lat, lng) {
                // 0,0 Ï¢åÌëú ÌïÑÌÑ∞ÎßÅ
                if (lat === 0 && lng === 0) {
                    console.log('[NaverMap] ‚ùå Invalid: 0,0 coordinate');
                    return false;
                }
                // ÌïúÍµ≠ Î≤îÏúÑ Ï≤¥ÌÅ¨ (ÏúÑÎèÑ 33~43, Í≤ΩÎèÑ 124~132)
                if (lat < 33 || lat > 43 || lng < 124 || lng > 132) {
                    console.log('[NaverMap] ‚ùå Invalid: out of Korea range', lat, lng);
                    return false;
                }
                return true;
            },
            
            // ‚≠ê Ï†êÌîÑ Í±∞Î¶¨ Ï≤¥ÌÅ¨ (ÎÑàÎ¨¥ Î©ÄÎ©¥ Î¨¥Ïãú)
            isReasonableJump: function(lat, lng) {
                if (this.rawGPSPoints.length === 0) return true;
                
                var lastPoint = this.rawGPSPoints[this.rawGPSPoints.length - 1];
                var distance = calculateDistance(lastPoint.lat(), lastPoint.lng(), lat, lng);
                
                // 100m Ï¥àÍ≥º Ï†êÌîÑÎäî Î¨¥Ïãú
                if (distance > 100) {
                    console.log('[NaverMap] ‚ùå Jump too far:', distance.toFixed(0) + 'm');
                    return false;
                }
                return true;
            },
            
            // Catmull-Rom Spline Î≥¥Í∞Ñ
            catmullRomSpline: function(p0, p1, p2, p3, t) {
                var t2 = t * t;
                var t3 = t2 * t;
                return {
                    lat: 0.5 * ((2 * p1.lat) +
                        (-p0.lat + p2.lat) * t +
                        (2 * p0.lat - 5 * p1.lat + 4 * p2.lat - p3.lat) * t2 +
                        (-p0.lat + 3 * p1.lat - 3 * p2.lat + p3.lat) * t3),
                    lng: 0.5 * ((2 * p1.lng) +
                        (-p0.lng + p2.lng) * t +
                        (2 * p0.lng - 5 * p1.lng + 4 * p2.lng - p3.lng) * t2 +
                        (-p0.lng + 3 * p1.lng - 3 * p2.lng + p3.lng) * t3)
                };
            },
            
            // Î∂ÄÎìúÎü¨Ïö¥ Í≤ΩÎ°ú ÏÉùÏÑ±
            generateSmoothPath: function(points) {
                if (points.length < 2) return points;
                if (points.length === 2) return points;
                
                var smoothPath = [];
                var segmentsPerPoint = 5; // Ìè¨Ïù∏Ìä∏ ÏÇ¨Ïù¥ Î≥¥Í∞Ñ Í∞úÏàò
                
                for (var i = 0; i < points.length - 1; i++) {
                    var p0 = points[Math.max(0, i - 1)];
                    var p1 = points[i];
                    var p2 = points[Math.min(points.length - 1, i + 1)];
                    var p3 = points[Math.min(points.length - 1, i + 2)];
                    
                    // Ï≤´ Ìè¨Ïù∏Ìä∏Îäî Ìï≠ÏÉÅ Ï∂îÍ∞Ä
                    if (i === 0) {
                        smoothPath.push(new naver.maps.LatLng(p1.lat(), p1.lng()));
                    }
                    
                    // Î≥¥Í∞Ñ Ìè¨Ïù∏Ìä∏ Ï∂îÍ∞Ä
                    for (var j = 1; j <= segmentsPerPoint; j++) {
                        var t = j / segmentsPerPoint;
                        var interpolated = this.catmullRomSpline(
                            {lat: p0.lat(), lng: p0.lng()},
                            {lat: p1.lat(), lng: p1.lng()},
                            {lat: p2.lat(), lng: p2.lng()},
                            {lat: p3.lat(), lng: p3.lng()},
                            t
                        );
                        smoothPath.push(new naver.maps.LatLng(interpolated.lat, interpolated.lng));
                    }
                }
                
                return smoothPath;
            },
            
            // ÎßàÏßÄÎßâ Íµ¨Í∞ÑÎßå Î∂ÄÎìúÎüΩÍ≤å ÏóÖÎç∞Ïù¥Ìä∏
            updateLastSegmentSmooth: function() {
                var points = this.rawGPSPoints;
                if (points.length < 2) return;
                
                // ÎßàÏßÄÎßâ 4Í∞ú Ìè¨Ïù∏Ìä∏Î°ú Î≥¥Í∞Ñ
                var startIdx = Math.max(0, points.length - 4);
                var lastPoints = points.slice(startIdx);
                
                if (lastPoints.length < 2) return;
                
                // ÏÉà Íµ¨Í∞ÑÏùò Î≥¥Í∞Ñ Ìè¨Ïù∏Ìä∏ ÏÉùÏÑ±
                var newSegment = [];
                var segmentsPerPoint = 5;
                
                for (var i = 0; i < lastPoints.length - 1; i++) {
                    var idx = startIdx + i;
                    var p0 = points[Math.max(0, idx - 1)];
                    var p1 = points[idx];
                    var p2 = points[Math.min(points.length - 1, idx + 1)];
                    var p3 = points[Math.min(points.length - 1, idx + 2)];
                    
                    for (var j = 1; j <= segmentsPerPoint; j++) {
                        var t = j / segmentsPerPoint;
                        var interpolated = this.catmullRomSpline(
                            {lat: p0.lat(), lng: p0.lng()},
                            {lat: p1.lat(), lng: p1.lng()},
                            {lat: p2.lat(), lng: p2.lng()},
                            {lat: p3.lat(), lng: p3.lng()},
                            t
                        );
                        newSegment.push(new naver.maps.LatLng(interpolated.lat, interpolated.lng));
                    }
                }
                
                // Í∏∞Ï°¥ path ÏóÖÎç∞Ïù¥Ìä∏ (ÎßàÏßÄÎßâ Íµ¨Í∞Ñ ÍµêÏ≤¥)
                if (routePath && newSegment.length > 0) {
                    var path = routePath.getPath();
                    var removeCount = Math.min((lastPoints.length - 1) * segmentsPerPoint, path.length - 1);
                    
                    // Ïù¥Ï†Ñ Î≥¥Í∞Ñ Ìè¨Ïù∏Ìä∏ Ï†úÍ±∞
                    while (removeCount > 0 && path.length > 1) {
                        path.pop();
                        removeCount--;
                    }
                    
                    // ÏÉà Î≥¥Í∞Ñ Ìè¨Ïù∏Ìä∏ Ï∂îÍ∞Ä
                    newSegment.forEach(function(coord) {
                        path.push(coord);
                    });
                }
            },
            
            appendPoint: function(lat, lng) {
                if (typeof naver === 'undefined' || !naver.maps) return;
                
                // ‚≠ê‚≠ê‚≠ê Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Ï∂îÍ∞Ä ‚≠ê‚≠ê‚≠ê
                if (!this.isValidCoordinate(lat, lng)) {
                    return; // 0,0 ÎòêÎäî ÌïúÍµ≠ Î∞ñ Ï¢åÌëú Î¨¥Ïãú
                }
                
                if (!this.isReasonableJump(lat, lng)) {
                    return; // 100m Ï¥àÍ≥º Ï†êÌîÑ Î¨¥Ïãú
                }
                
                var newCoord = new naver.maps.LatLng(lat, lng);
                
                // ÏõêÎ≥∏ GPS Ìè¨Ïù∏Ìä∏ Ï†ÄÏû•
                this.rawGPSPoints.push(newCoord);
                routeCoordinates.push(newCoord);
                
                // Í±∞Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏
                if (this.rawGPSPoints.length >= 2) {
                    var prev = this.rawGPSPoints[this.rawGPSPoints.length - 2];
                    var dist = calculateDistance(prev.lat(), prev.lng(), lat, lng);
                    totalDistance += dist;
                    document.getElementById('distance').textContent = Math.round(totalDistance);
                }
                
                // Polyline ÏÉùÏÑ±/ÏóÖÎç∞Ïù¥Ìä∏
                if (this.rawGPSPoints.length === 2) {
                    // Ï≤´ Polyline ÏÉùÏÑ± (Î∂ÄÎìúÎü¨Ïö¥ Í≤ΩÎ°ú)
                    var smoothPath = this.generateSmoothPath(this.rawGPSPoints);
                    routePath = new naver.maps.Polyline({
                        map: map,
                        path: smoothPath,
                        strokeColor: '#4285F4',
                        strokeOpacity: 0.9,
                        strokeWeight: 6,
                        strokeLineCap: 'round',
                        strokeLineJoin: 'round'
                    });
                } else if (this.rawGPSPoints.length > 2) {
                    // ÎßàÏßÄÎßâ Íµ¨Í∞ÑÎßå Î∂ÄÎìúÎüΩÍ≤å ÏóÖÎç∞Ïù¥Ìä∏
                    this.updateLastSegmentSmooth();
                }
                
                // Ìè¨Ïù∏Ìä∏ Ïàò ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('pointCount').textContent = this.rawGPSPoints.length;
                
                console.log('[NaverMap] ‚úÖ appendPoint: ' + lat.toFixed(6) + ', ' + lng.toFixed(6) + 
                            ' | raw: ' + this.rawGPSPoints.length);
            },
            
            // drawRouteÎäî Î≥µÏõêÏö©ÏúºÎ°úÎßå ÏÇ¨Ïö© (Ï†ÑÏ≤¥ Îã§Ïãú Í∑∏Î¶¨Í∏∞ - Î∂ÄÎìúÎüΩÍ≤å)
            drawRoute: function(pointsArray) {
                if (typeof naver === 'undefined' || !naver.maps) return;
                if (!Array.isArray(pointsArray)) {
                    try { pointsArray = JSON.parse(pointsArray); } catch (e) { return; }
                }
                
                // ÏõêÎ≥∏ Ìè¨Ïù∏Ìä∏ Ï†ÄÏû• (Ïú†Ìö®Ìïú Ï¢åÌëúÎßå!)
                this.rawGPSPoints = [];
                routeCoordinates = [];
                
                var self = this;
                var lastValidPoint = null;
                
                pointsArray.forEach(function(p) {
                    // ‚≠ê Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                    if (!self.isValidCoordinate(p.lat, p.lng)) {
                        return; // 0,0 ÎòêÎäî ÌïúÍµ≠ Î∞ñ Î¨¥Ïãú
                    }
                    
                    // Ï†êÌîÑ Í±∞Î¶¨ Ï≤¥ÌÅ¨
                    if (lastValidPoint) {
                        var distance = calculateDistance(lastValidPoint.lat, lastValidPoint.lng, p.lat, p.lng);
                        if (distance > 100) {
                            console.log('[NaverMap] drawRoute skip jump:', distance.toFixed(0) + 'm');
                            return; // 100m Ï¥àÍ≥º Ï†êÌîÑ Î¨¥Ïãú
                        }
                    }
                    
                    var coord = new naver.maps.LatLng(p.lat, p.lng);
                    self.rawGPSPoints.push(coord);
                    routeCoordinates.push(coord);
                    lastValidPoint = p;
                });
                
                // Î∂ÄÎìúÎü¨Ïö¥ Í≤ΩÎ°úÎ°ú Polyline ÏÉùÏÑ±
                if (routePath) routePath.setMap(null);
                
                if (this.rawGPSPoints.length > 1) {
                    var smoothPath = this.generateSmoothPath(this.rawGPSPoints);
                    routePath = new naver.maps.Polyline({
                        map: map,
                        path: smoothPath,
                        strokeColor: '#4285F4',
                        strokeOpacity: 0.9,
                        strokeWeight: 6,
                        strokeLineCap: 'round',
                        strokeLineJoin: 'round'
                    });
                }
                
                document.getElementById('pointCount').textContent = this.rawGPSPoints.length;
                
                console.log('[NaverMap] drawRoute (filtered): ' + this.rawGPSPoints.length + '/' + pointsArray.length + ' points');
            }
        };

        function initMap() {
            if (typeof naver === 'undefined' || !naver.maps) {
                setTimeout(initMap, 500);
                return;
            }
            
            if (isFloatingMode) document.body.classList.add('floating-mode');
            
            const savedState = StateManager.restoreState();
            
            const mapOptions = {
                center: savedState && savedState.center ? 
                    new naver.maps.LatLng(savedState.center.lat, savedState.center.lng) : 
                    new naver.maps.LatLng(37.5665, 126.9780),
                zoom: savedState ? savedState.zoom : 16,
                mapTypeControl: false,
                scaleControl: false,
                logoControl: true,
                mapDataControl: false,
                zoomControl: !isFloatingMode,
                zoomControlOptions: { position: naver.maps.Position.TOP_RIGHT },
                draggable: !isFloatingMode,
                scrollWheel: !isFloatingMode
            };

            map = new naver.maps.Map('map', mapOptions);
            window.NaverMapBridge.map = map;
            
            if (!isFloatingMode) {
                naver.maps.Event.addListener(map, 'dragend', function() { StateManager.saveState(); });
                naver.maps.Event.addListener(map, 'zoom_changed', function() { StateManager.saveState(); });
            }
            
            if (savedState) applyRestoredState(savedState);
            updateStatusDisplay();
            console.log('Map initialized');
        }

        function updateStatusDisplay() {
            const statusEl = document.getElementById('status');
            statusEl.textContent = isTracking ? 'Ï∂îÏ†Å Ï§ë' : 'ÎåÄÍ∏∞Ï§ë';
            statusEl.className = isTracking ? 'status-tracking' : '';
        }

        function applyRestoredState(state) {
            if (!state || typeof naver === 'undefined') return;
            
            if (state.routeCoordinates && state.routeCoordinates.length > 0) {
                routeCoordinates = state.routeCoordinates.map(p => new naver.maps.LatLng(p.lat, p.lng));
                totalDistance = state.totalDistance || 0;
                updateRoute();
                
                if (routeCoordinates.length > 0) {
                    if (startMarker) startMarker.setMap(null);
                    startMarker = new naver.maps.Marker({
                        position: routeCoordinates[0],
                        map: map,
                        icon: {
                            content: '<div style="width:15px;height:15px;background:#00C73C;border-radius:50%;border:2px solid white;"></div>',
                            anchor: new naver.maps.Point(9, 9)
                        },
                        zIndex: 90
                    });
                }
                
                document.getElementById('pointCount').textContent = routeCoordinates.length;
                document.getElementById('distance').textContent = Math.round(totalDistance);
            }
            
            if (state.isTracking) {
                isTracking = true;
                updateStatusDisplay();
            }
        }

        function addFirstRoutePoint(lat, lng) {
            if (typeof naver === 'undefined') return;
            
            const point = new naver.maps.LatLng(lat, lng);
            routeCoordinates.push(point);
            
            if (startMarker) startMarker.setMap(null);
            startMarker = new naver.maps.Marker({
                position: point,
                map: map,
                icon: {
                    content: '<div style="width:15px;height:15px;background:#00C73C;border-radius:50%;border:2px solid white;"></div>',
                    anchor: new naver.maps.Point(9, 9)
                },
                zIndex: 90
            });
            
            map.setCenter(point);
            document.getElementById('pointCount').textContent = routeCoordinates.length;
            StateManager.saveState();
        }

        function addStartMarkerAt(lat, lng) {
            if (typeof naver === 'undefined') return;
            const point = new naver.maps.LatLng(lat, lng);
            if (startMarker) startMarker.setMap(null);
            startMarker = new naver.maps.Marker({
                position: point,
                map: map,
                icon: {
                    content: '<div style="width:15px;height:15px;background:#00C73C;border-radius:50%;border:2px solid white;"></div>',
                    anchor: new naver.maps.Point(9, 9)
                },
                zIndex: 90
            });
        }

        function updateCurrentMarker(lat, lng) {
            if (typeof naver === 'undefined') return;
            const point = new naver.maps.LatLng(lat, lng);
            window.NaverMapBridge.userLocation = point;
            
            if (userMarker) {
                userMarker.setPosition(point);
            } else if (map) {
                userMarker = new naver.maps.Marker({
                    position: point,
                    map: map,
                    icon: {
                        content: '<div style="width:20px;height:20px;background:#4285F4;border-radius:50%;border:3px solid white;"></div>',
                        anchor: new naver.maps.Point(13, 13)
                    },
                    zIndex: 100
                });
            }
        }

        function clearMarkers() {
            if (startMarker) { startMarker.setMap(null); startMarker = null; }
            if (endMarker) { endMarker.setMap(null); endMarker = null; }
            if (userMarker) { userMarker.setMap(null); userMarker = null; }
        }

        function startTracking() {
            if (typeof naver === 'undefined') return;
            if (!isTracking) {
                isTracking = true;
                if (routeCoordinates.length === 0) totalDistance = 0;
                updateStatusDisplay();
                StateManager.saveState();
            }
        }

        function stopTracking() {
            if (typeof naver === 'undefined') return;
            if (isTracking) {
                isTracking = false;
                if (routeCoordinates.length > 0) {
                    if (endMarker) endMarker.setMap(null);
                    endMarker = new naver.maps.Marker({
                        position: routeCoordinates[routeCoordinates.length - 1],
                        map: map,
                        icon: {
                            content: '<div style="width:15px;height:15px;background:#FF3E3E;border-radius:50%;border:2px solid white;"></div>',
                            anchor: new naver.maps.Point(9, 9)
                        },
                        zIndex: 90
                    });
                }
                updateStatusDisplay();
                StateManager.saveState();
            }
        }

        function addRoutePoint(lat, lng) {
            if (typeof naver === 'undefined') return;
            routeCoordinates.push(new naver.maps.LatLng(lat, lng));
            updateRoute();
            document.getElementById('pointCount').textContent = routeCoordinates.length;
            if (isFloatingMode || routeCoordinates.length % 5 === 0) StateManager.saveState();
        }

        function clearRoute() {
            routeCoordinates = [];
            // rawGPSPointsÎèÑ Ï¥àÍ∏∞Ìôî
            if (window.NaverMapBridge) {
                window.NaverMapBridge.rawGPSPoints = [];
            }
            isTracking = false;
            totalDistance = 0;
            if (routePath) { routePath.setMap(null); routePath = null; }
            clearMarkers();
            document.getElementById('pointCount').textContent = '0';
            document.getElementById('distance').textContent = '0';
            updateStatusDisplay();
            StateManager.clearState();
        }

        function updateRoute() {
            if (typeof naver === 'undefined') return;
            if (routePath) routePath.setMap(null);
            
            if (routeCoordinates.length > 1) {
                routePath = new naver.maps.Polyline({
                    map: map,
                    path: routeCoordinates,
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.9,
                    strokeWeight: 6,
                    strokeLineCap: 'round',
                    strokeLineJoin: 'round'
                });
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateInfoPanel(lat, lng, accuracy) {
            document.getElementById('lat').textContent = lat.toFixed(6);
            document.getElementById('lng').textContent = lng.toFixed(6);
            document.getElementById('accuracy').textContent = accuracy ? accuracy.toFixed(1) + 'm' : 'N/A';
        }

        document.addEventListener('touchmove', function(e) {
            if (!e.target.closest('#map')) e.preventDefault();
        }, { passive: false });

        window.startRoute = startTracking;
        window.stopRoute = stopTracking;
        window.clearRoute = clearRoute;
        window.addRoutePoint = addRoutePoint;
        window.clearMarkers = clearMarkers;
        window.addStartMarker = addStartMarkerAt;
        window.updateCurrentLocation = updateCurrentMarker;

        window.restoreRoute = function(pointsJson) {
            if (typeof naver === 'undefined' || !naver.maps) return;
            try {
                const points = typeof pointsJson === 'string' ? JSON.parse(pointsJson) : pointsJson;
                routeCoordinates = [];
                totalDistance = 0;
                
                points.forEach((p, index) => {
                    const point = new naver.maps.LatLng(p.lat, p.lng);
                    routeCoordinates.push(point);
                    if (index > 0) {
                        const prevPoint = routeCoordinates[index - 1];
                        totalDistance += calculateDistance(prevPoint.lat(), prevPoint.lng(), point.lat(), point.lng());
                    }
                });
                
                updateRoute();
                
                if (routeCoordinates.length > 0) {
                    if (startMarker) startMarker.setMap(null);
                    startMarker = new naver.maps.Marker({
                        position: routeCoordinates[0],
                        map: map,
                        icon: { content: '<div style="width:15px;height:15px;background:#00C73C;border-radius:50%;border:2px solid white;"></div>', anchor: new naver.maps.Point(9, 9) }
                    });
                }
                
                document.getElementById('pointCount').textContent = routeCoordinates.length;
                document.getElementById('distance').textContent = Math.round(totalDistance);
                StateManager.saveState();
            } catch (e) { console.error('Failed to restore route:', e); }
        };

        // ============= Ï∫°Ï≤ò ÏãúÏä§ÌÖú =============
        
        let captureState = {
            isCapturing: false,
            originalCenter: null,
            originalZoom: null
        };

        function hideCaptureUI() {
            console.log('Hiding UI for capture...');
            var panel = document.getElementById('info-panel');
            if (panel) panel.classList.add('capture-hidden');
            
            var selectors = [
                '[class*="btn_zoom"]', '[class*="zoom"]', '.naver-map-control',
                '[class*="map_btn"]', '[class*="btn_"]', '[class*="ctrl"]', '[class*="control"]'
            ];
            selectors.forEach(function(selector) {
                var elements = document.querySelectorAll(selector);
                elements.forEach(function(el) {
                    el.style.setProperty('display', 'none', 'important');
                    el.style.setProperty('visibility', 'hidden', 'important');
                    el.style.setProperty('opacity', '0', 'important');
                });
            });
            if (map) { map.setOptions({ zoomControl: false, scaleControl: false }); }
        }
        
        function showCaptureUI() {
            console.log('Showing UI after capture...');
            var panel = document.getElementById('info-panel');
            if (panel) panel.classList.remove('capture-hidden');
            
            var selectors = [
                '[class*="btn_zoom"]', '[class*="zoom"]', '.naver-map-control',
                '[class*="map_btn"]', '[class*="btn_"]', '[class*="ctrl"]', '[class*="control"]'
            ];
            selectors.forEach(function(selector) {
                var elements = document.querySelectorAll(selector);
                elements.forEach(function(el) {
                    el.style.removeProperty('display');
                    el.style.removeProperty('visibility');
                    el.style.removeProperty('opacity');
                });
            });
            if (map && !isFloatingMode) { map.setOptions({ zoomControl: true }); }
        }

        window.NaverMapBridge.startFullRouteCapture = function(zoom) {
            if (captureState.isCapturing) { console.log('Already capturing...'); return; }
            if (routeCoordinates.length < 2) {
                console.log('No route to capture');
                window.Unity.call('N/CAPTURE_ERROR:No route data');
                return;
            }
            console.log('========== STARTING SINGLE CAPTURE ==========');
            captureState.isCapturing = true;
            captureState.originalCenter = map.getCenter();
            captureState.originalZoom = map.getZoom();
            hideCaptureUI();
            var bounds = new naver.maps.LatLngBounds();
            routeCoordinates.forEach(function(coord) { bounds.extend(coord); });
            map.fitBounds(bounds, { top: 30, right: 30, bottom: 30, left: 30 });
            setTimeout(function() {
                var info = { totalTiles: 1, zoom: map.getZoom(), cols: 1, rows: 1 };
                window.Unity.call('N/CAPTURE_START:' + JSON.stringify(info));
                setTimeout(function() {
                    var tileData = { index: 0, row: 0, col: 0, total: 1 };
                    window.Unity.call('N/CAPTURE_TILE:' + JSON.stringify(tileData));
                }, 2000);
            }, 500);
        };

        window.NaverMapBridge.onTileCaptured = function(tileIndex) {
            console.log('Single tile captured!');
            window.Unity.call('N/CAPTURE_PROGRESS:100');
            setTimeout(function() { finishCapture(); }, 300);
        };

        function finishCapture() {
            console.log('========== CAPTURE COMPLETE ==========');
            if (captureState.originalCenter && captureState.originalZoom) {
                map.setCenter(captureState.originalCenter);
                map.setZoom(captureState.originalZoom);
            }
            showCaptureUI();
            captureState.isCapturing = false;
            window.Unity.call('N/CAPTURE_COMPLETE:' + JSON.stringify({ cols: 1, rows: 1, total: 1 }));
        }

        window.NaverMapBridge.cancelCapture = function() {
            if (captureState.isCapturing) {
                console.log('Capture cancelled');
                captureState.isCapturing = false;
                if (captureState.originalCenter && captureState.originalZoom) {
                    map.setCenter(captureState.originalCenter);
                    map.setZoom(captureState.originalZoom);
                }
                showCaptureUI();
                window.Unity.call('N/CAPTURE_CANCELLED');
            }
        };

        // Ï¥àÍ∏∞Ìôî
        window.onload = function() {
            if (typeof naver !== 'undefined' && naver.maps) {
                initMap();
            } else {
                setTimeout(initMap, 500);
            }
        };
    </script>
</body>
</html>
