<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>ë„¤ì´ë²„ ì§€ë„ - ë§Œë³´ê¸° GPS íŠ¸ë˜í‚¹</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=0lep6flysx"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        html, body {
            width: 100%;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 100;
            min-width: 120px;
        }
        .control-panel button {
            display: block;
            width: 100%;
            padding: 8px 10px;
            margin: 5px 0;
            background: #03c75a;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .control-panel button:hover {
            background: #02b351;
        }
        .control-panel button.active {
            background: #ff6b6b;
        }
        .control-panel button.capture {
            background: #4285F4;
        }
        .control-panel button.capture:hover {
            background: #357ae8;
        }
        .info-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 100;
            font-size: 12px;
        }
        .route-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 100;
            font-size: 14px;
            display: none;
        }
        .route-info.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="route-info" id="routeInfo">
        <div>ì´ë™ ê±°ë¦¬: <span id="distanceInfo">0</span> m</div>
        <div>ê²½ë¡œ í¬ì¸íŠ¸: <span id="pointsInfo">0</span> ê°œ</div>
        <div>ë‚ ì§œ: <span id="dateInfo"></span></div>
    </div>
    <div class="control-panel">
        <button onClick="getCurrentLocation()">ğŸ“ ë‚´ ìœ„ì¹˜</button>
        <button id="trackBtn" onClick="toggleTracking()">ğŸƒ ê²½ë¡œ ì¶”ì </button>
        <button onClick="clearPath()">ğŸ—‘ï¸ ê²½ë¡œ ì‚­ì œ</button>
        <button onClick="fitMapToRoute()">ğŸ” ì „ì²´ ê²½ë¡œ</button>  <!-- ì¶”ê°€ -->
        <button onClick="toggleMapType()">ğŸ—ºï¸ ì§€ë„ íƒ€ì…</button>
        <button class="capture" onClick="captureMap()">ğŸ“¸ ì§€ë„ ì €ì¥</button>
        <button onClick="debugStatus()">ğŸ› ìƒíƒœí™•ì¸</button>
    </div>
    <div class="info-panel" id="infoPanel">
        <div>ìœ„ë„: <span id="latInfo">-</span></div>
        <div>ê²½ë„: <span id="lngInfo">-</span></div>
        <div>ì •í™•ë„: <span id="accInfo">-</span>m</div>
    </div>

    <script>
        // ì§€ë„ ì´ˆê¸°í™”
        var mapOptions = {
            center: new naver.maps.LatLng(37.5666805, 126.9784147),
            zoom: 16,
            mapTypeId: naver.maps.MapTypeId.NORMAL,
            zoomControl: true,
            zoomControlOptions: {
                position: naver.maps.Position.TOP_LEFT
            }
        };

        var map = new naver.maps.Map('map', mapOptions);
        var markers = [];
        var currentLocationMarker = null;
        var accuracyCircle = null;
        var routePath = [];
        var routePolyline = null;
        var isTracking = false;
        var watchId = null;
        var unityRouteTracking = false;
        var totalDistance = 0;
        var trackingStartTime = null;

        // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
        function calculateDistance(lat1, lng1, lat2, lng2) {
            var R = 6371000; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ì§€ë„ ì €ì¥ ë²„íŠ¼ í´ë¦­ì‹œ
function captureMap() {
    console.log("Capture button clicked");
    
    sendToUnity('save_static_map', {
        message: 'Request from HTML',  // <- ì‰¼í‘œ ì¶”ê°€
        pointCount: routePath.length,
        distance: totalDistance
    });
    
    console.log("Message sent to Unity");
}

        // Unityì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ì „ì—­ ê°ì²´
        window.NaverMapBridge = {
            updateLocation: function(lat, lng, accuracy) {
        console.log(`Received location: ${lat}, ${lng}, accuracy: ${accuracy}`);
        updateCurrentPosition(lat, lng, accuracy);
        
        if (isTracking || unityRouteTracking) {
            window.addRoutePoint(lat, lng);
            console.log('Route point added from Unity');
        }
    },
            
            moveToLocation: function(lat, lng) {
        var latlng = new naver.maps.LatLng(lat, lng);
        map.panTo(latlng);
        console.log(`Map moved to: ${lat}, ${lng}`);
    },
    
    setZoom: function(level) {
        map.setZoom(level);
        console.log(`Zoom set to: ${level}`);
    },
    
    startTracking: function() {
        console.log('Unity called startTracking');
        window.startRoute();
    },
    
    stopTracking: function() {
        unityRouteTracking = false;
        console.log('Route tracking stopped from Unity');
    },
    
    clearTracking: function() {
        window.clearRoute();
        console.log('Route cleared from Unity');
    },
    
    captureMap: function() {
        captureMap();
    }
        };

        // Unityì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ê²½ë¡œ í•¨ìˆ˜ë“¤
        window.startRoute = function() {
            console.log('=== startRoute called ===');
            unityRouteTracking = true;
            isTracking = true;  // ì¶”ê°€ í•„ìš”
            routePath = [];
            totalDistance = 0;
            trackingStartTime = new Date();
            if (routePolyline) {
                routePolyline.setMap(null);
            }
            // UI ì—…ë°ì´íŠ¸
    document.getElementById('trackBtn').classList.add('active');
    document.getElementById('trackBtn').textContent = 'â¹ï¸ ì¶”ì  ì¤‘ì§€';
    
    console.log('Route tracking started from Unity');
    console.log(`Tracking states - isTracking: ${isTracking}, unityRouteTracking: ${unityRouteTracking}`);
        }

        window.addRoutePoint = function(lat, lng) {
            if (!isTracking && !unityRouteTracking) return;
            
            var position = new naver.maps.LatLng(lat, lng);
            
            // ê±°ë¦¬ ê³„ì‚°
            if (routePath.length > 0) {
                var lastPoint = routePath[routePath.length - 1];
                var distance = calculateDistance(
                    lastPoint.lat(), lastPoint.lng(),
                    lat, lng
                );
                if (distance > 2) { // 2ë¯¸í„° ì´ìƒ ì´ë™ì‹œë§Œ ì¶”ê°€
                    totalDistance += distance;
                    routePath.push(position);
                }
            } else {
                routePath.push(position);
            }
            
            if (routePolyline) {
                routePolyline.setPath(routePath);
            } else if (routePath.length > 1) {
                routePolyline = new naver.maps.Polyline({
                    map: map,
                    path: routePath,
                    strokeColor: '#FF0080',
                    strokeOpacity: 0.8,
                    strokeWeight: 4,
                    strokeLineCap: 'round',
                    strokeLineJoin: 'round'
                });
            }
            
            console.log('Route point added:', lat, lng, 'Total:', routePath.length, 'Distance:', totalDistance);
        }

        window.clearRoute = function() {
            unityRouteTracking = false;
            routePath = [];
            totalDistance = 0;
            if (routePolyline) {
                routePolyline.setMap(null);
                routePolyline = null;
            }
            console.log('Route cleared from Unity');
        }

        // í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updateCurrentPosition(lat, lng, accuracy) {
            var position = new naver.maps.LatLng(lat, lng);
            
            document.getElementById('latInfo').textContent = lat.toFixed(6);
            document.getElementById('lngInfo').textContent = lng.toFixed(6);
            document.getElementById('accInfo').textContent = accuracy ? accuracy.toFixed(0) : '-';
            
            if (currentLocationMarker) {
                currentLocationMarker.setMap(null);
            }
            if (accuracyCircle) {
                accuracyCircle.setMap(null);
            }
            
            if (accuracy && accuracy > 0) {
                accuracyCircle = new naver.maps.Circle({
                    center: position,
                    radius: accuracy,
                    map: map,
                    strokeColor: '#4285F4',
                    strokeOpacity: 0.3,
                    strokeWeight: 1,
                    fillColor: '#4285F4',
                    fillOpacity: 0.1
                });
            }
            
            currentLocationMarker = new naver.maps.Marker({
                position: position,
                map: map,
                icon: {
                    content: '<div style="position:relative;">' +
                            '<div style="width:14px;height:14px;background:#4285F4;border:3px solid white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>' +
                            '<div style="position:absolute;width:6px;height:6px;background:white;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%);"></div>' +
                            '</div>',
                    anchor: new naver.maps.Point(10, 10)
                },
                zIndex: 1000
            });
            
            sendToUnity('location_updated', {
                lat: lat,
                lng: lng,
                accuracy: accuracy
            });
        }

        function getCurrentLocation() {
            if (currentLocationMarker) {
                var position = currentLocationMarker.getPosition();
                map.setCenter(position);
                map.setZoom(17);
                console.log('Moving to Unity GPS position');
            } else {
                console.log('No Unity GPS, waiting for data');
                alert('Unity GPS ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
            }
        }

        function toggleTracking() {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        }
        

        function startTracking() {
            console.log('startTracking called');
            
            isTracking = true;
            unityRouteTracking = true;
            totalDistance = 0;
            trackingStartTime = new Date();
            
            document.getElementById('trackBtn').classList.add('active');
            document.getElementById('trackBtn').textContent = 'â¹ï¸ ì¶”ì  ì¤‘ì§€';
            
            routePath = [];
            if (routePolyline) {
                routePolyline.setMap(null);
            }
            
            sendToUnity('tracking_started', {});
        }

        function stopTracking() {
    isTracking = false;
    unityRouteTracking = false;
    
    document.getElementById('trackBtn').classList.remove('active');
    document.getElementById('trackBtn').textContent = 'ğŸƒ ê²½ë¡œ ì¶”ì ';
    
    // ê²½ë¡œ ì¶”ì  ì™„ë£Œ ì²˜ë¦¬
    if (routePath.length >= 2) {
        onTrackingComplete();  // fitMapToRoute() ëŒ€ì‹  onTrackingComplete() í˜¸ì¶œ
    }
    
    sendToUnity('tracking_stopped', {
        totalPoints: routePath.length,
        totalDistance: totalDistance
    });
}

        function clearPath() {
            routePath = [];
            totalDistance = 0;
            if (routePolyline) {
                routePolyline.setMap(null);
                routePolyline = null;
            }
            sendToUnity('path_cleared', {});
        }

        function toggleMapType() {
            var currentType = map.getMapTypeId();
            if (currentType === naver.maps.MapTypeId.NORMAL) {
                map.setMapTypeId(naver.maps.MapTypeId.SATELLITE);
            } else if (currentType === naver.maps.MapTypeId.SATELLITE) {
                map.setMapTypeId(naver.maps.MapTypeId.HYBRID);
            } else {
                map.setMapTypeId(naver.maps.MapTypeId.NORMAL);
            }
        }

        function debugStatus() {
    var status = 
        'Tracking: ' + isTracking + '\n' +
        'Unity Tracking: ' + unityRouteTracking + '\n' +
        'Route Points: ' + routePath.length + '\n' +
        'Distance: ' + totalDistance.toFixed(0) + 'm\n' +
        'Has Marker: ' + (currentLocationMarker != null) + '\n' +
        'Current Position: ' + (currentLocationMarker ? 
            currentLocationMarker.getPosition().toString() : 'N/A');
    
    alert(status);
    console.log('Debug Status:', status);
}
        
        // ì „ì²´ ê²½ë¡œê°€ ë³´ì´ë„ë¡ ì§€ë„ ì¡°ì •
function fitMapToRoute() {
    if (routePath.length < 2) return;
    
    // ê²½ë¡œì˜ ê²½ê³„ ê³„ì‚°
    var bounds = new naver.maps.LatLngBounds();
    
    for (var i = 0; i < routePath.length; i++) {
        bounds.extend(routePath[i]);
    }
    
    // ì§€ë„ë¥¼ ê²½ê³„ì— ë§ì¶° ì¡°ì • (ì—¬ë°± ì¶”ê°€)
    map.fitBounds(bounds, {
        top: 100,
        right: 100,
        bottom: 100,
        left: 100
    });
    
    console.log('Map fitted to route bounds');
}
        
        // ê±°ë¦¬ì— ë”°ë¥¸ ì ì ˆí•œ ì¤Œ ë ˆë²¨ ê³„ì‚°
function calculateZoomForDistance(totalDistanceMeters) {
    if (totalDistanceMeters < 500) return 17;      // 500m ì´í•˜
    else if (totalDistanceMeters < 1000) return 16; // 1km ì´í•˜
    else if (totalDistanceMeters < 2000) return 15; // 2km ì´í•˜
    else if (totalDistanceMeters < 5000) return 14; // 5km ì´í•˜
    else if (totalDistanceMeters < 10000) return 13; // 10km ì´í•˜
    else if (totalDistanceMeters < 20000) return 12; // 20km ì´í•˜
    else if (totalDistanceMeters < 50000) return 11; // 50km ì´í•˜
    else return 10;
}

// ê²½ë¡œ ì¶”ì  ì™„ë£Œì‹œ í˜¸ì¶œ
function onTrackingComplete() {
    var zoomLevel = calculateZoomForDistance(totalDistance);
    
    // ì „ì²´ ê²½ë¡œê°€ ë³´ì´ë„ë¡ ì¡°ì •
    fitMapToRoute();
    
    // ë˜ëŠ” ê³„ì‚°ëœ ì¤Œ ë ˆë²¨ ì‚¬ìš© (ì„ íƒì‚¬í•­)
    // map.setZoom(zoomLevel);
    
    console.log(`Tracking complete. Distance: ${totalDistance}m, Zoom: ${zoomLevel}`);
}

        function sendToUnity(eventType, data) {
    var message = {
        type: eventType,
        data: data,
        timestamp: Date.now()
    };
    
    // GPMWebView ë°©ì‹
    if (window.location.href.indexOf('unity://') === -1) {
        // scheme ì§ì ‘ ì „ì†¡
        window.location.href = 'unity://' + eventType;
        console.log('Sent via scheme:', 'unity://' + eventType);
    }
    
    console.log('Sent to Unity:', message);
}

        naver.maps.Event.addListener(map, 'click', function(e) {
            sendToUnity('map_clicked', {
                lat: e.coord.lat(),
                lng: e.coord.lng()
            });
        });

        naver.maps.Event.addListener(map, 'zoom_changed', function() {
            sendToUnity('zoom_changed', {
                zoom: map.getZoom()
            });
        });

        window.onload = function() {
            sendToUnity('map_ready', {});
            console.log('Naver Map Ready');
        };
    </script>
</body>
</html>